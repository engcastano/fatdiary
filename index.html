<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RunnerPro</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 12h-4l-3 9L9 3l-3 9H2'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 24 24' fill='%230f172a' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect width='24' height='24' fill='%230f172a'/%3E%3Cpath d='M22 12h-4l-3 9L9 3l-3 9H2'/%3E%3C/svg%3E">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        body { margin: 0; padding: 0; overflow-x: hidden; }
        @media screen and (max-width: 768px) { input, select, textarea { font-size: 16px !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, className, onClick }) => {
            React.useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} onClick={onClick}></i>;
        };

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDIi4ze3AqhiLFCN66F3ije-8z1HrXmJPc",
            authDomain: "runnerpro.firebaseapp.com",
            projectId: "runnerpro",
            storageBucket: "runnerpro.firebasestorage.app",
            messagingSenderId: "519704813498",
            appId: "1:519704813498:web:86885c46ba568ddcd70783",
            measurementId: "G-2HVE5XR6X4"
        };

        let auth, db, googleProvider;
        const isFirebaseConfigured = !!firebaseConfig.apiKey;

        if (isFirebaseConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                googleProvider = new GoogleAuthProvider();
            } catch (error) { console.error("Firebase Error:", error); }
        }

        // UTILS
        const displayDate = (dateString) => {
            if(!dateString || typeof dateString !== 'string') return "-";
            try {
                const parts = dateString.split('-');
                if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
                return dateString;
            } catch (e) { return dateString; }
        };

        // Helper para converter minutos decimais em HH:MM:SS string
        const minutesToTimeStr = (totalMinutes) => {
            if (!totalMinutes || isNaN(totalMinutes)) return "00:00:00";
            const h = Math.floor(totalMinutes / 60);
            const m = Math.floor(totalMinutes % 60);
            const s = Math.round((totalMinutes - Math.floor(totalMinutes)) * 60);
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        };

        const formatPace = (decimalPace) => {
            if (!decimalPace || decimalPace === Infinity || isNaN(decimalPace)) return "0:00";
            const min = Math.floor(decimalPace);
            const sec = Math.round((decimalPace - min) * 60);
            return `${min}:${sec.toString().padStart(2, '0')}`;
        };

        const calculateAge = (dob) => {
            if(!dob) return 30; 
            const diff = Date.now() - new Date(dob).getTime();
            return Math.abs(new Date(diff).getUTCFullYear() - 1970);
        };

        const calculateTMB = (weight, height, age, gender) => {
            if (!weight || !height || !age) return 0;
            let tmb = (10 * weight) + (6.25 * height) - (5 * age);
            tmb += (gender === 'female') ? -161 : 5;
            return tmb;
        };

        const calculateBurn = (met, weight, durationMin) => {
            if(!met || !weight || !durationMin) return 0;
            return met * 3.5 * (weight / 200) * durationMin;
        };

        const calculateMET = (distKm, timeMin) => {
            if(!distKm || !timeMin || timeMin === 0) return 0;
            const speedMetersPerMin = (distKm * 1000) / timeMin;
            const vo2 = (0.2 * speedMetersPerMin) + (0.9 * speedMetersPerMin * 0.01) + 3.5;
            return vo2 / 3.5;
        };

        const findClosestWeight = (targetDate, weights) => {
            if(!weights || weights.length === 0) return null;
            const sortedWeights = [...weights].filter(w => w && w.date).sort((a,b) => new Date(b.date) - new Date(a.date));
            const match = sortedWeights.find(w => w.date <= targetDate);
            return match ? parseFloat(match.weight) : (sortedWeights.length > 0 ? parseFloat(sortedWeights[sortedWeights.length-1].weight) : 70);
        };

        const predictMarathon = (longRuns) => {
            if (!longRuns || longRuns.length === 0) return "—";
            const validRuns = longRuns.filter(r => r && r.pace && r.distance > 0);
            if (validRuns.length === 0) return "—";
            
            const bestLong = validRuns.reduce((prev, current) => (prev.pace < current.pace && prev.distance > 15) ? prev : current, validRuns[0]);
            if (bestLong.distance < 10) return "—";
            
            const t1 = bestLong.duration; 
            const d1 = bestLong.distance;
            const d2 = 42.195;
            const predictedTimeMin = t1 * Math.pow((d2 / d1), 1.06);
            const h = Math.floor(predictedTimeMin / 60);
            const m = Math.floor(predictedTimeMin % 60);
            return `${h}h ${m}m`;
        };

        // --- CHARTS ---
        const SimpleLineChart = ({ data, dataKey, color = "#10b981", height = 100 }) => {
            const safeData = data ? data.filter(d => d && !isNaN(parseFloat(d[dataKey]))) : [];
            if (safeData.length < 2) return <div className="text-xs text-gray-500 h-24 flex items-center justify-center">Dados insuficientes</div>;
            const values = safeData.map(d => parseFloat(d[dataKey]) || 0);
            const max = Math.max(...values) * 1.1;
            const min = Math.min(...values) * 0.9;
            const range = max - min || 1; 
            const points = values.map((val, idx) => {
                const x = (idx / (values.length - 1)) * 100;
                const y = 100 - ((val - min) / range) * 100;
                return `${x},${y}`;
            }).join(" ");
            return (
                <div className="w-full relative" style={{ height: `${height}px` }}>
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                        <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke"/>
                        {values.map((val, idx) => {
                            const x = (idx / (values.length - 1)) * 100;
                            const y = 100 - ((val - min) / range) * 100;
                            return <circle key={idx} cx={x} cy={y} r="3" fill={color} className="opacity-0 hover:opacity-100 transition-opacity cursor-pointer"><title>{val}</title></circle>
                        })}
                    </svg>
                </div>
            );
        };

        // --- SCREENS ---
        const LoginScreen = ({ onLogin, isDark, toggleTheme, isOnline }) => {
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');

            const handleGuestLogin = () => {
                onLogin({ uid: 'guest_user', name: 'Convidado Local', email: 'offline@runnerpro.local', photo: null, isAnonymous: true });
            };

            const handleGoogle = async () => {
                setIsLoading(true); setErrorMsg('');
                if(!isFirebaseConfigured) { handleGuestLogin(); return; }
                try { await signInWithPopup(auth, googleProvider); } 
                catch(e) { 
                    if(e.code === 'auth/unauthorized-domain') setErrorMsg("Domínio não autorizado. Use 'Sem conta' por enquanto.");
                    else if(e.code === 'auth/popup-closed-by-user') setErrorMsg("Login cancelado.");
                    else setErrorMsg(e.message);
                    setIsLoading(false);
                }
            };

            return (
                <div className={`min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-500 ${isDark ? 'bg-slate-950 text-white' : 'bg-gray-50 text-gray-900'}`}>
                    <div className="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-emerald-500/30"><Icon name="activity" className="w-8 h-8 text-white"/></div>
                    <h1 className="text-3xl font-bold mb-2">RunnerPro</h1>
                    <p className={`mb-8 ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>Coach Metabólico & Performance</p>
                    <div className="w-full max-w-sm space-y-4">
                        <button onClick={handleGoogle} disabled={isLoading} className={`w-full py-3.5 px-6 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg ${isDark ? 'bg-white text-slate-900 hover:bg-gray-100' : 'bg-white text-slate-900 border border-gray-200 hover:bg-gray-50'}`}>
                            {isLoading ? 'Conectando...' : <><Icon name="log-in" className="w-5 h-5"/> Entrar com Google</>}
                        </button>
                        <div className="relative flex items-center justify-center py-2"><div className={`absolute inset-0 flex items-center`}> <div className={`w-full border-t ${isDark ? 'border-slate-800' : 'border-gray-200'}`}></div></div><span className={`relative px-3 text-xs uppercase tracking-wider ${isDark ? 'bg-slate-950 text-gray-500' : 'bg-gray-50 text-gray-400'}`}>ou</span></div>
                        <button onClick={handleGuestLogin} className={`w-full py-3.5 px-6 rounded-xl font-bold flex items-center justify-center gap-2 transition-all border-2 ${isDark ? 'border-slate-800 text-slate-300 hover:bg-slate-800' : 'border-gray-200 text-gray-600 hover:bg-gray-100'}`}><Icon name="user-x" className="w-5 h-5"/> Continuar sem conta (Offline)</button>
                    </div>
                    {errorMsg && <div className="mt-6 p-3 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-xs text-center max-w-sm">{errorMsg}</div>}
                    <div className="mt-8 flex gap-2 items-center">
                        <span className={`text-[10px] px-2 py-0.5 rounded-full border flex items-center ${isFirebaseConfigured ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/30' : 'bg-orange-500/10 text-orange-500 border-orange-500/30'}`}>{isFirebaseConfigured ? <><Icon name="wifi" className="w-3 h-3 mr-1"/> Online</> : <><Icon name="wifi-off" className="w-3 h-3 mr-1"/> Local</>}</span>
                        <button onClick={toggleTheme} className={`text-xs flex items-center gap-1 px-3 py-1 rounded-full transition-colors ${isDark ? 'text-gray-500 hover:bg-slate-800' : 'text-gray-400 hover:bg-white border border-gray-200'}`}>{isDark ? <Icon name="sun" className="w-3 h-3"/> : <Icon name="moon" className="w-3 h-3"/>} Tema</button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ view, setView, isDark, toggleTheme, isOpen, setIsOpen, handleLogout }) => {
            const items = [
                {id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard'},
                {id: 'history', icon: 'clipboard-list', label: 'Histórico'},
                {id: 'weight', icon: 'scale', label: 'Peso Corporal'},
                {id: 'metabolic', icon: 'flame', label: 'Metabólico'},
                {id: 'equipment', icon: 'package', label: 'Equipamentos'},
                {id: 'settings', icon: 'settings', label: 'Configurações'},
            ];
            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={()=>setIsOpen(false)}></div>}
                    <aside className={`fixed top-0 left-0 h-full w-64 border-r z-50 transition-transform duration-300 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>
                        <div className="p-6 flex items-center justify-between">
                            <div className="flex items-center gap-3"><div className="w-8 h-8 rounded bg-emerald-500 flex items-center justify-center text-white"><Icon name="activity" className="w-5 h-5"/></div><span className={`font-bold text-xl ${isDark ? 'text-white' : 'text-slate-900'}`}>RunnerPro</span></div>
                            <button onClick={()=>setIsOpen(false)} className="md:hidden text-gray-400"><Icon name="x" className="w-6 h-6"/></button>
                        </div>
                        <nav className="px-4 py-4 space-y-1">
                            {items.map(item => (
                                <button key={item.id} onClick={()=>{setView(item.id); setIsOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === item.id ? 'bg-emerald-500/10 text-emerald-500 font-bold' : (isDark ? 'text-gray-400 hover:bg-slate-800 hover:text-white' : 'text-gray-500 hover:bg-gray-100 hover:text-slate-900')}`}><Icon name={item.icon} className="w-5 h-5"/>{item.label}</button>
                            ))}
                        </nav>
                        <div className={`absolute bottom-0 w-full p-4 border-t space-y-2 ${isDark ? 'border-slate-800' : 'border-gray-200'}`}>
                            <button onClick={toggleTheme} className={`w-full flex items-center gap-3 px-4 py-2 text-sm ${isDark ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-slate-900'}`}><Icon name={isDark ? 'sun' : 'moon'} className="w-4 h-4"/> Alternar Tema</button>
                            <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-2 text-red-400 hover:text-red-500 text-sm"><Icon name="log-out" className="w-4 h-4"/> Sair</button>
                        </div>
                    </aside>
                </>
            );
        };

        // --- VIEWS ---
        const WeightView = ({ weights, setWeights, isOnline, user }) => {
            const [date, setDate] = useState(new Date().toISOString().substr(0, 10));
            const [kg, setKg] = useState('');
            const handleSave = async (e) => {
                e.preventDefault();
                if(!kg) return;
                const data = { date, weight: parseFloat(kg), createdAt: new Date().toISOString() };
                if(isOnline && !user.isAnonymous) { await addDoc(collection(db, `users/${user.uid}/weights`), data); } 
                else { setWeights(prev => [...prev, {...data, id: Date.now().toString()}].sort((a,b) => new Date(b.date) - new Date(a.date))); }
                setKg('');
            };
            const handleDelete = async (id) => {
                if(!confirm("Apagar?")) return;
                if(isOnline && !user.isAnonymous) await deleteDoc(doc(db, `users/${user.uid}/weights`, id));
                else setWeights(prev => prev.filter(w => w.id !== id));
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    const batch = [];
                    lines.forEach(line => {
                        const parts = line.split(/[;,]/);
                        if(parts.length >= 2) {
                            let dateStr = parts[0].trim();
                            let weightVal = parseFloat(parts[1].replace(',', '.'));
                            if(dateStr.includes('/')) { const [d, m, y] = dateStr.split('/'); if(y.length === 4) dateStr = `${y}-${m}-${d}`; }
                            if(!isNaN(weightVal) && dateStr.length === 10) { batch.push({ date: dateStr, weight: weightVal, createdAt: new Date().toISOString() }); }
                        }
                    });
                    if(confirm(`Importar ${batch.length} registros de peso?`)) {
                        if(isOnline && !user.isAnonymous) { for(let w of batch) await addDoc(collection(db, `users/${user.uid}/weights`), w); } 
                        else { setWeights(prev => [...prev, ...batch].sort((a,b) => new Date(b.date) - new Date(a.date))); }
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };
            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Controle de Peso</h2><label className="cursor-pointer bg-slate-800 text-white text-xs px-3 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition-colors"><Icon name="upload" className="w-3 h-3"/> Importar CSV<input type="file" accept=".csv" className="hidden" onChange={handleImport}/></label></div>
                    <form onSubmit={handleSave} className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 flex gap-4 items-end shadow-sm">
                        <div className="flex-1"><label className="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Data</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-2 text-gray-900 dark:text-white outline-none focus:border-emerald-500"/></div>
                        <div className="flex-1"><label className="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Peso (kg)</label><input type="number" step="0.1" value={kg} onChange={e=>setKg(e.target.value)} className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-2 text-gray-900 dark:text-white outline-none focus:border-emerald-500" placeholder="00.0"/></div>
                        <button className="bg-emerald-600 p-2.5 rounded-lg text-white hover:bg-emerald-700 transition-colors"><Icon name="plus" className="w-5 h-5"/></button>
                    </form>
                    <div className="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 overflow-hidden shadow-sm">
                        <table className="w-full text-sm text-left"><thead className="bg-gray-50 dark:bg-slate-900/50 text-gray-500 dark:text-gray-400 text-xs uppercase"><tr><th className="p-3">Data</th><th className="p-3">Peso</th><th className="p-3 text-right">Ação</th></tr></thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-slate-700">
                                {weights.map(w => (<tr key={w.id} className="hover:bg-gray-50 dark:hover:bg-slate-700/30"><td className="p-3">{displayDate(w.date)}</td><td className="p-3 font-bold text-emerald-600 dark:text-emerald-400">{w.weight} kg</td><td className="p-3 text-right"><button onClick={()=>handleDelete(w.id)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" className="w-4 h-4"/></button></td></tr>))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MetabolicView = ({ workouts, weights, biometrics, consumption, setConsumption, user, isOnline }) => {
            const data = useMemo(() => {
                const map = {};
                workouts.forEach(w => {
                    if(!w || !w.date) return;
                    if(!map[w.date]) map[w.date] = { date: w.date, activities: [], totalActivityKcal: 0, consumption: 0 };
                    const closestWeight = findClosestWeight(w.date, weights) || (biometrics.weight || 70); 
                    let burn = 0;
                    const dur = parseFloat(w.duration) || 0;
                    if(w.isDistance && w.met) { burn = calculateBurn(w.met, closestWeight, dur); } 
                    else { burn = calculateBurn(6, closestWeight, dur); }
                    map[w.date].activities.push({ ...w, burn });
                    map[w.date].totalActivityKcal += burn;
                    map[w.date].weight = closestWeight;
                });
                const today = new Date();
                const days = [];
                for(let i=0; i<30; i++) {
                    const d = new Date(); d.setDate(today.getDate() - i);
                    const iso = d.toISOString().substr(0,10);
                    const dayData = map[iso] || { date: iso, activities: [], totalActivityKcal: 0 };
                    dayData.weight = findClosestWeight(iso, weights) || (biometrics.weight || 70);
                    const age = calculateAge(biometrics.dob);
                    dayData.tmb = calculateTMB(dayData.weight, biometrics.height, age, biometrics.gender);
                    const cons = consumption.find(c => c && c.date === iso);
                    dayData.consumption = cons ? cons.kcal : '';
                    dayData.consId = cons ? cons.id : null;
                    days.push(dayData);
                }
                return days;
            }, [workouts, weights, biometrics, consumption]);

            const handleConsumptionChange = async (date, val, id) => {
                const kcal = parseInt(val);
                if(isOnline && !user.isAnonymous) {
                    if(id) { if(isNaN(kcal)) await deleteDoc(doc(db, `users/${user.uid}/consumption`, id)); else await updateDoc(doc(db, `users/${user.uid}/consumption`, id), { kcal }); } 
                    else if(!isNaN(kcal)) { await addDoc(collection(db, `users/${user.uid}/consumption`), { date, kcal }); }
                } else {
                    if(id) setConsumption(prev => prev.map(c => c.id === id ? { ...c, kcal: kcal || 0 } : c));
                    else setConsumption(prev => [...prev, { id: Date.now().toString(), date, kcal: kcal || 0 }]);
                }
            };

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <h2 className="text-2xl font-bold">Compilado Metabólico</h2>
                    <div className="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 overflow-x-auto shadow-sm">
                        <table className="w-full text-sm text-left whitespace-nowrap"><thead className="bg-gray-50 dark:bg-slate-900/50 text-gray-500 dark:text-gray-400 text-xs uppercase"><tr><th className="p-3">Data</th><th className="p-3">Peso (kg)</th><th className="p-3 text-blue-500 dark:text-blue-400">TMB (Basal)</th><th className="p-3 text-orange-500 dark:text-orange-400">Atividade</th><th className="p-3 text-emerald-500 dark:text-emerald-400">Gasto Total</th><th className="p-3">Consumo (Input)</th><th className="p-3">Balanço</th></tr></thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-slate-700">{data.map(day => (<tr key={day.date} className="hover:bg-gray-50 dark:hover:bg-slate-700/30"><td className="p-3">{displayDate(day.date)}</td><td className="p-3">{day.weight}</td><td className="p-3">{day.tmb.toFixed(0)}</td><td className="p-3">{day.totalActivityKcal.toFixed(0)}</td><td className="p-3 font-bold">{(day.tmb + day.totalActivityKcal).toFixed(0)}</td><td className="p-3"><input type="number" className="w-20 bg-gray-100 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-1 text-center outline-none focus:border-emerald-500" placeholder="Kcal" value={day.consumption} onChange={(e) => handleConsumptionChange(day.date, e.target.value, day.consId)}/></td><td className={`p-3 font-bold ${day.consumption - (day.tmb + day.totalActivityKcal) > 0 ? 'text-red-500 dark:text-red-400' : 'text-emerald-500 dark:text-emerald-400'}`}>{day.consumption ? (day.consumption - (day.tmb + day.totalActivityKcal)).toFixed(0) : '-'}</td></tr>))}</tbody>
                        </table>
                    </div>
                    <div className="text-xs text-gray-500 space-y-1 p-4 border-t border-gray-200 dark:border-slate-800"><p><strong>Notas de Cálculo:</strong></p><p>• <strong>TMB:</strong> Fórmula de Mifflin-St. Jeor (Requer altura, peso, idade e gênero configurados).</p><p>• <strong>Atividade:</strong> MET * 3.5 * Peso / 200 * Minutos.</p><p>• ⚠️ <strong>Atenção:</strong> Se você não registrar o peso, o sistema usará o último registrado ou um padrão de 70kg.</p></div>
                </div>
            );
        };

        const Dashboard = ({ workouts, weights }) => {
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            
            // PROTECTED DASHBOARD LOGIC
            const filteredData = useMemo(() => {
                return workouts.filter(w => {
                    if(!w || !w.date) return false;
                    try {
                        const parts = w.date.split('-');
                        if(parts.length !== 3) return false;
                        const month = parseInt(parts[1]) - 1; 
                        const year = parseInt(parts[0]);
                        return year === filterYear && (filterMonth === 'all' || month === parseInt(filterMonth));
                    } catch(e) { return false; }
                });
            }, [workouts, filterYear, filterMonth]);
            
            const volumeKm = filteredData.reduce((a,b) => a + (b.isDistance ? (parseFloat(b.distance)||0) : 0), 0);
            const volumeMET = filteredData.reduce((a,b) => a + ((parseFloat(b.met)||0) * (parseFloat(b.duration)||0)), 0); 
            
            // Safe Pace Calc
            const validPaceRuns = filteredData.filter(x => (parseFloat(x.pace)||0) > 0);
            const avgPace = validPaceRuns.length > 0 
                ? validPaceRuns.reduce((a,b) => a + parseFloat(b.pace), 0) / validPaceRuns.length 
                : 0;

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <div className="flex gap-2 mb-6">
                        <select value={filterYear} onChange={e=>setFilterYear(parseInt(e.target.value))} className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded p-2 text-sm">{[2023,2024,2025,2026].map(y => <option key={y} value={y}>{y}</option>)}</select>
                        <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded p-2 text-sm"><option value="all">Ano Todo</option>{['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].map((m,i)=><option key={i} value={i}>{m}</option>)}</select>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm"><div className="text-xs text-gray-500 dark:text-gray-400 uppercase mb-1">Volume Total</div><div className="text-2xl font-bold text-emerald-500 dark:text-emerald-400">{volumeKm.toFixed(1)} <span className="text-sm text-gray-400 dark:text-gray-500">km</span></div></div>
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm"><div className="text-xs text-gray-500 dark:text-gray-400 uppercase mb-1">Carga (MET.min)</div><div className="text-2xl font-bold text-orange-500 dark:text-orange-400">{volumeMET.toFixed(0)}</div></div>
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm"><div className="text-xs text-gray-500 dark:text-gray-400 uppercase mb-1">Pace Médio</div><div className="text-2xl font-bold text-blue-500 dark:text-blue-400">{avgPace > 0 ? `${Math.floor(avgPace)}:${Math.round((avgPace%1)*60).toString().padStart(2,'0')}` : '-'}</div></div>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm"><h3 className="font-semibold mb-4 flex items-center text-sm uppercase text-gray-500 dark:text-gray-400"><Icon name="scale" className="w-4 h-4 mr-2"/> Evolução de Peso</h3><SimpleLineChart data={[...weights].reverse()} dataKey="weight" color="#f472b6" height={150} /></div>
                </div>
            );
        };

        const EquipmentView = ({ shoes, setShoes, isDark, isOnline, user, workouts }) => {
            const [newShoe, setNewShoe] = useState({ name: '', brand: '', maxKm: 800 });
            const handleAddShoe = async (e) => {
                e.preventDefault();
                if (!newShoe.name) return;
                const shoeData = { ...newShoe, active: true, createdAt: new Date().toISOString() };
                if (isOnline && !user?.isAnonymous) { await addDoc(collection(db, `users/${user.uid}/shoes`), shoeData); } 
                else { setShoes(prev => [...prev, { ...shoeData, id: Date.now().toString() }]); }
                setNewShoe({ name: '', brand: '', maxKm: 800 });
            };
            const deleteItem = async (id) => {
                if(!confirm("Remover este tênis?")) return;
                if(isOnline && !user?.isAnonymous) { await deleteDoc(doc(db, `users/${user.uid}/shoes`, id)); } 
                else { setShoes(prev => prev.filter(s => s.id !== id)); }
            };
            const getMileage = (shoeId) => { return workouts.filter(w => w.shoeId == shoeId && w.isDistance).reduce((acc, curr) => acc + (parseFloat(curr.distance) || 0), 0); };
            return (
                <div className="space-y-6 pb-24 md:pb-10 animate-fade-in">
                    <h2 className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>Meus Equipamentos</h2>
                    <form onSubmit={handleAddShoe} className={`p-4 rounded-xl border flex flex-col md:flex-row gap-4 items-end ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-200'}`}>
                        <div className="flex-1 w-full"><label className="text-xs mb-1 block opacity-70">Modelo</label><input className={`w-full rounded p-2 border ${isDark ? 'bg-slate-900 border-slate-600 text-white' : 'bg-white border-gray-300'}`} value={newShoe.name} onChange={e => setNewShoe({...newShoe, name: e.target.value})} placeholder="Ex: Pegasus 40" /></div>
                        <div className="flex-1 w-full"><label className="text-xs mb-1 block opacity-70">Marca</label><input className={`w-full rounded p-2 border ${isDark ? 'bg-slate-900 border-slate-600 text-white' : 'bg-white border-gray-300'}`} value={newShoe.brand} onChange={e => setNewShoe({...newShoe, brand: e.target.value})} placeholder="Nike" /></div>
                        <div className="w-full md:w-32"><label className="text-xs mb-1 block opacity-70">Vida Útil (km)</label><input type="number" className={`w-full rounded p-2 border ${isDark ? 'bg-slate-900 border-slate-600 text-white' : 'bg-white border-gray-300'}`} value={newShoe.maxKm} onChange={e => setNewShoe({...newShoe, maxKm: e.target.value})} /></div>
                        <button className="w-full md:w-auto bg-emerald-600 p-2.5 rounded text-white hover:bg-emerald-700"><Icon name="plus-circle" className="w-5 h-5 mx-auto"/></button>
                    </form>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {shoes.map(shoe => {
                            const currentKm = getMileage(shoe.id);
                            const lifeLeft = Math.max(0, 100 - (currentKm / shoe.maxKm * 100));
                            return (
                                <div key={shoe.id} className={`p-5 rounded-xl border relative group ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-200'}`}>
                                    <div className="flex justify-between items-start mb-4">
                                        <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center ${isDark ? 'bg-slate-700' : 'bg-gray-100'}`}><Icon name="package" className="w-5 h-5 opacity-70"/></div><div><h3 className="font-bold">{shoe.brand} {shoe.name}</h3><span className="text-xs text-emerald-500">Ativo</span></div></div>
                                        <button onClick={() => deleteItem(shoe.id)} className="text-gray-400 hover:text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button>
                                    </div>
                                    <div><div className="flex justify-between text-xs font-medium mb-1 opacity-70"><span>{currentKm.toFixed(1)} km rodados</span><span>{shoe.maxKm} km max</span></div><div className={`h-2.5 rounded-full overflow-hidden ${isDark ? 'bg-slate-700' : 'bg-gray-100'}`}><div className={`h-full transition-all duration-500 ${lifeLeft < 20 ? 'bg-red-500' : 'bg-emerald-500'}`} style={{ width: `${(currentKm / shoe.maxKm) * 100}%` }}></div></div></div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ user, workoutTypes, workouts, shoes, handleLogout, handleAddType, deleteItem, setWorkoutTypes, setWorkouts, setShoes, setUser, isDark, isOnline }) => {
            const cardBg = isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-200 shadow-sm';
            const inputBg = isDark ? 'bg-slate-900 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900';
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editDist, setEditDist] = useState(false);

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.workouts && importedData.settings && importedData.shoes) {
                            if (confirm(`Importar backup?`)) {
                                setWorkouts(importedData.workouts);
                                setShoes(importedData.shoes);
                                setWorkoutTypes(importedData.settings);
                                alert("Importado com sucesso!");
                            }
                        } else { alert("Arquivo inválido."); }
                    } catch (error) { alert("Erro ao ler arquivo."); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const startEdit = (t) => { setEditingId(t.id); setEditName(t.name); setEditDist(t.isDistance); };
            const saveEdit = (id) => { setWorkoutTypes(prev => prev.map(t => t.id === id ? { ...t, name: editName, isDistance: editDist } : t)); setEditingId(null); };

            return (
                <div className="space-y-6 pb-24 md:pb-10 animate-fade-in">
                    <div className="flex items-center justify-between"><h2 className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>Configurações</h2><button onClick={handleLogout} className="text-red-500 text-sm flex items-center hover:text-red-600 font-medium px-3 py-1 rounded bg-red-50 dark:bg-red-900/10"><Icon name="log-out" className="w-4 h-4 mr-1"/> Sair</button></div>
                    <div className={`${cardBg} p-5 rounded-xl border`}>
                        <h3 className={`font-medium mb-4 flex items-center ${isDark ? 'text-white' : 'text-gray-900'}`}><Icon name="settings" className="w-4 h-4 mr-2"/> Gerenciar Tipos de Treino</h3>
                        <form onSubmit={handleAddType} className="flex gap-2 mb-4"><input name="typeName" required placeholder="Novo tipo..." className={`flex-1 rounded p-2 border ${inputBg} focus:outline-none focus:ring-2 focus:ring-emerald-500`}/><div className={`flex items-center px-3 rounded border ${isDark ? 'border-slate-600 bg-slate-900' : 'border-gray-300 bg-gray-50'}`}><input type="checkbox" name="typeIsDistance" id="chkDist" className="mr-2 accent-emerald-500"/><label htmlFor="chkDist" className="text-xs cursor-pointer">Corrida?</label></div><button className="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 transition-colors">Add</button></form>
                        <ul className="space-y-2">{workoutTypes.map(t => (<li key={t.id} className={`flex justify-between items-center p-3 rounded-lg text-sm ${isDark ? 'bg-slate-900' : 'bg-gray-50 border border-gray-100'}`}>{editingId === t.id ? (<div className="flex flex-1 items-center gap-2"><input value={editName} onChange={e=>setEditName(e.target.value)} className={`flex-1 rounded p-1 border ${inputBg}`} /><label className="flex items-center text-xs"><input type="checkbox" checked={editDist} onChange={e=>setEditDist(e.target.checked)} className="mr-1"/> Corrida?</label><button onClick={()=>saveEdit(t.id)} className="text-emerald-500"><Icon name="check-square" className="w-4 h-4"/></button></div>) : (<span className={isDark ? 'text-gray-300' : 'text-gray-700'}>{t.name} <span className="text-xs ml-2 opacity-50">{t.isDistance ? '(Corrida)' : '(Outro)'}</span></span>)}<div className="flex gap-2">{!editingId && <button onClick={()=>startEdit(t)} className="text-blue-400 hover:text-blue-300"><Icon name="edit" className="w-4 h-4"/></button>}<button onClick={() => deleteItem(setWorkoutTypes, workoutTypes, t.id)} className="text-gray-400 hover:text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></div></li>))}</ul>
                    </div>
                    <div className={`${cardBg} p-5 rounded-xl border`}><h3 className={`font-medium mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>Backup & Dados</h3><p className="text-xs mb-4 opacity-50">Exporte seus dados para segurança.</p><div className="flex flex-wrap gap-3"><button onClick={() => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ user, settings: workoutTypes, workouts, shoes })); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", `runner_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(node); node.click(); node.remove(); }} className={`px-4 py-2 rounded-lg text-sm flex items-center transition-colors ${isDark ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}><Icon name="download" className="w-4 h-4 mr-2"/> Exportar JSON</button><label className={`cursor-pointer px-4 py-2 rounded-lg text-sm flex items-center transition-colors ${isDark ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}><Icon name="upload" className="w-4 h-4 mr-2"/> Importar JSON <input type="file" accept=".json" onChange={handleImportData} className="hidden" /></label></div></div>
                </div>
            );
        };

        const AddWorkoutModal = ({ isOpen, onClose, onSave, initialData, workoutTypes, shoes, isDark, isBulkEdit }) => {
            if (!isOpen) return null;
            const [formData, setFormData] = useState({ typeId: '1', date: new Date().toISOString().substr(0, 10), distance: '', duration: '', hrAvg: '', hrMax: '', power: '', rpe: '', elevation: '', notes: '', shoeId: '' });
            const [durationStr, setDurationStr] = useState("");

            // Reset or Load Data
            useEffect(() => { 
                if (isOpen) {
                    if (initialData) { 
                        setFormData({ ...formData, ...initialData }); 
                        const totalMin = parseFloat(initialData.duration) || 0;
                        if (totalMin > 0) {
                            const h = Math.floor(totalMin / 60);
                            const m = Math.floor(totalMin % 60);
                            const s = Math.round((totalMin - Math.floor(totalMin)) * 60);
                            const pad = (n) => n.toString().padStart(2, '0');
                            setDurationStr(`${pad(h)}:${pad(m)}:${pad(s)}`);
                        } else setDurationStr("");
                    } else {
                        // Reset form
                        setFormData({ typeId: '1', date: new Date().toISOString().substr(0, 10), distance: '', duration: '', hrAvg: '', hrMax: '', power: '', rpe: '', elevation: '', notes: '', shoeId: '' });
                        setDurationStr("");
                    }
                }
            }, [isOpen, initialData]);

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                let totalMinutes = 0;
                if (durationStr) {
                    const parts = durationStr.split(':').map(p => parseInt(p) || 0);
                    if (parts.length === 3) totalMinutes = parts[0] * 60 + parts[1] + parts[2] / 60;
                    else if (parts.length === 2) totalMinutes = parts[0] * 60 + parts[1];
                    else if (parts.length === 1) totalMinutes = parts[0];
                }
                // Ensure valid number string
                onSave({ ...formData, duration: totalMinutes }); 
            };
            
            const selectedType = workoutTypes.find(t => t.id === formData.typeId);
            const isDistance = selectedType ? selectedType.isDistance : false;
            const inputClass = `w-full rounded-lg p-2.5 border text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all ${isDark ? 'bg-slate-800 border-slate-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`;
            
            return (
                <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className={`rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto border ${isDark ? 'bg-slate-900 border-slate-700' : 'bg-white border-gray-200'}`}>
                        <div className={`flex justify-between items-center p-4 border-b ${isDark ? 'border-slate-800 bg-slate-800/50' : 'border-gray-100 bg-gray-50'}`}><h2 className={`text-lg font-bold flex items-center ${isDark ? 'text-white' : 'text-gray-800'}`}>{isBulkEdit ? 'Editar em Massa' : 'Registrar'}</h2><button onClick={onClose}><Icon name="x" className="w-6 h-6 text-gray-400"/></button></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-5">
                            <div className="grid grid-cols-2 gap-5">
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Tipo</label><select value={formData.typeId} onChange={e=>setFormData({...formData, typeId:e.target.value})} className={inputClass}>{workoutTypes.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Data</label><input type="date" disabled={isBulkEdit} value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className={inputClass}/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-5">
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Tempo (hh:mm:ss)</label><input type="text" placeholder="00:00:00" value={durationStr} onChange={e=>setDurationStr(e.target.value)} className={inputClass} /></div>
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>RPE (0-10)</label><input type="number" max="10" value={formData.rpe} onChange={e=>setFormData({...formData, rpe:e.target.value})} className={inputClass} placeholder="5"/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-5">
                                {isDistance && <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Distância (km)</label><input type="number" step="0.01" value={formData.distance} onChange={e=>setFormData({...formData, distance:e.target.value})} className={inputClass}/></div>}
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>FC Média</label><input type="number" value={formData.hrAvg} onChange={e=>setFormData({...formData, hrAvg:e.target.value})} className={inputClass} placeholder="bpm"/></div>
                            </div>
                            {isDistance && <div className="grid grid-cols-2 gap-5">
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Elevação (m)</label><input type="number" value={formData.elevation} onChange={e=>setFormData({...formData, elevation:e.target.value})} className={inputClass} placeholder="m"/></div>
                                <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Potência (W)</label><input type="number" value={formData.power} onChange={e=>setFormData({...formData, power:e.target.value})} className={inputClass} placeholder="W"/></div>
                            </div>}
                            <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Tênis</label><select value={formData.shoeId} onChange={e=>setFormData({...formData, shoeId:e.target.value})} className={inputClass}><option value="">Selecione...</option>{shoes.filter(s => s.active).map(s => <option key={s.id} value={s.id}>{s.brand} {s.name}</option>)}</select></div>
                            <div><label className={`text-xs font-medium mb-1.5 block ${isDark?'text-gray-400':'text-gray-600'}`}>Obs</label><textarea rows="3" value={formData.notes} onChange={e=>setFormData({...formData, notes:e.target.value})} className={inputClass}></textarea></div>
                            <button className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl">Salvar</button>
                        </form>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ workouts, setWorkouts, workoutTypes, isDark, onEdit, onDuplicate, onDelete }) => {
            const [selected, setSelected] = useState([]);
            const [filterText, setFilterText] = useState('');
            const [filterType, setFilterType] = useState('all');
            
            // SAFE FILTER & SORT
            const filteredWorkouts = useMemo(() => {
                if(!workouts) return [];
                return workouts.filter(w => {
                    if(!w) return false;
                    const typeName = w.typeName || '';
                    const notes = w.notes || '';
                    const matchesText = notes.toLowerCase().includes(filterText.toLowerCase()) || typeName.toLowerCase().includes(filterText.toLowerCase());
                    const matchesType = filterType === 'all' || w.typeId === filterType;
                    return matchesText && matchesType;
                });
            }, [workouts, filterText, filterType]);
            
            const toggleSelect = (id) => setSelected(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
            const toggleSelectAll = () => selected.length === filteredWorkouts.length ? setSelected([]) : setSelected(filteredWorkouts.map(w => w.id));
            const handleBulkDelete = () => { onDelete(selected); setSelected([]); };

            // Import CSV Logic
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    const batch = [];
                    lines.forEach(line => {
                        const parts = line.split(/[;,]/);
                        if(parts.length >= 2) {
                            let dateStr = parts[0].trim();
                            if(dateStr.includes('/')) { const [d, m, y] = dateStr.split('/'); if(y.length === 4) dateStr = `${y}-${m}-${d}`; }
                            if(dateStr.length === 10) {
                                batch.push({
                                    date: dateStr,
                                    duration: parseFloat(parts[2]) || 0,
                                    distance: parseFloat(parts[3]) || 0,
                                    rpe: parseFloat(parts[4]) || 5,
                                    typeName: parts[1] || 'Importado',
                                    typeId: '1', 
                                    isDistance: true,
                                    createdAt: new Date().toISOString()
                                });
                            }
                        }
                    });
                    if(confirm(`Importar ${batch.length} atividades?`)) {
                        setWorkouts(prev => [...prev, ...batch].sort((a,b) => new Date(b.date) - new Date(a.date)));
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h2 className="text-2xl font-bold">Histórico</h2>
                        <label className="cursor-pointer bg-slate-800 text-white text-xs px-3 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition-colors"><Icon name="upload" className="w-3 h-3"/> Importar CSV<input type="file" accept=".csv" className="hidden" onChange={handleImport}/></label>
                    </div>
                    
                    <div className="flex gap-2 w-full">
                        <div className="relative flex-1"><Icon name="search" className={`absolute left-3 top-2.5 w-4 h-4 ${isDark ? 'text-gray-500' : 'text-gray-400'}`}/><input type="text" placeholder="Buscar..." value={filterText} onChange={e => setFilterText(e.target.value)} className={`w-full pl-9 pr-4 py-2 rounded-lg border text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300'}`}/></div>
                        <select value={filterType} onChange={e => setFilterType(e.target.value)} className={`rounded-lg px-3 py-2 border text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300'}`}><option value="all">Todos</option>{workoutTypes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select>
                    </div>

                    {selected.length > 0 && <div className="p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex justify-between items-center"><span className="text-emerald-500 text-sm font-bold">{selected.length} selecionados</span><div className="flex gap-2"><button onClick={()=>onDuplicate(selected)} className="px-3 py-1 rounded bg-slate-700/50 hover:bg-slate-700 text-blue-400 text-xs font-bold flex items-center"><Icon name="copy" className="w-3 h-3 mr-1"/> Duplicar</button><button onClick={handleBulkDelete} className="px-3 py-1 rounded bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs font-bold flex items-center"><Icon name="trash-2" className="w-3 h-3 mr-1"/> Deletar</button></div></div>}
                    <div className={`rounded-xl border overflow-hidden overflow-x-auto ${isDark?'border-slate-700 bg-slate-800':'border-gray-200 bg-white'}`}>
                        <table className="w-full min-w-[600px] text-sm text-left">
                            <thead className={`uppercase text-xs ${isDark?'bg-slate-900/50':'bg-gray-50'}`}><tr><th className="p-3 w-10"><button onClick={toggleSelectAll}><Icon name={selected.length>0&&selected.length===filteredWorkouts.length?'check-square':'square'} className="w-4 h-4 opacity-50"/></button></th><th className="p-3">Data</th><th className="p-3">Tipo</th><th className="p-3">Dist</th><th className="p-3">Tempo</th><th className="p-3 text-emerald-500">Pace</th><th className="p-3 text-right">Ações</th></tr></thead>
                            <tbody>
                                {filteredWorkouts.map(w => {
                                    // SAFE RENDER VALUES
                                    const durVal = parseFloat(w.duration) || 0;
                                    const paceVal = parseFloat(w.pace) || 0;
                                    const typeLabel = w.typeName || 'Atividade';
                                    
                                    return (
                                    <tr key={w.id} className={`border-b ${isDark?'border-slate-700 hover:bg-slate-700/50':'border-gray-100 hover:bg-gray-50'}`}>
                                        <td className="p-3"><button onClick={()=>toggleSelect(w.id)}><Icon name={selected.includes(w.id)?'check-square':'square'} className={`w-4 h-4 ${selected.includes(w.id)?'text-emerald-500':'opacity-50'}`}/></button></td>
                                        <td className="p-3">{displayDate(w.date)}</td>
                                        <td className="p-3"><span className="px-2 py-0.5 rounded bg-emerald-500/10 text-emerald-500 text-xs font-bold">{typeLabel}</span></td>
                                        <td className="p-3">{w.isDistance ? w.distance + 'km' : '-'}</td>
                                        <td className="p-3">{Math.floor(durVal)}m {Math.round((durVal%1)*60)}s</td>
                                        <td className="p-3 font-bold text-emerald-500">{w.isDistance ? formatPace(paceVal) : '-'}</td>
                                        <td className="p-3 text-right flex justify-end gap-2">
                                            <button onClick={()=>onDuplicate([w.id])} className="text-blue-400 hover:text-blue-300"><Icon name="copy" className="w-4 h-4"/></button>
                                            <button onClick={()=>{onEdit(w)}} className="text-yellow-500 hover:text-yellow-400"><Icon name="edit" className="w-4 h-4"/></button>
                                            <button onClick={()=>onDelete([w.id])} className="text-red-500 hover:text-red-400"><Icon name="trash-2" className="w-4 h-4"/></button>
                                        </td>
                                    </tr>
                                )})}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        };

        const RunnerApp = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [isDark, setIsDark] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            // DATA STATES
            const [workouts, setWorkouts] = useState([]);
            const [weights, setWeights] = useState([]);
            const [shoes, setShoes] = useState([]);
            const [biometrics, setBiometrics] = useState({ height: 170, dob: '1990-01-01', gender: 'male' });
            const [consumption, setConsumption] = useState([]); 

            const [showAddModal, setShowAddModal] = useState(false);
            const [editingData, setEditingData] = useState(null);
            const [isBulkEdit, setIsBulkEdit] = useState(false);
            const [workoutTypes, setWorkoutTypes] = useState([
                { id: '1', name: 'Corrida Leve', isDistance: true },
                { id: '2', name: 'Treino Longo', isDistance: true },
                { id: '3', name: 'Fartlek', isDistance: true },
                { id: '4', name: 'Limiar', isDistance: true },
                { id: '5', name: 'Regenerativo', isDistance: true },
                { id: '6', name: 'Musculação', isDistance: false },
                { id: '7', name: 'Cárdio Indoor', isDistance: false }
            ]);

            useEffect(() => {
                const docEl = document.documentElement;
                if(isDark) docEl.classList.add('dark'); 
                else docEl.classList.remove('dark');
                document.body.style.backgroundColor = isDark ? '#020617' : '#f9fafb';
                
                if(!isFirebaseConfigured || user?.isAnonymous) {
                    const u = localStorage.getItem('rp_user'); if(u && !user) setUser(JSON.parse(u));
                    const w = localStorage.getItem('rp_workouts'); if(w) setWorkouts(JSON.parse(w));
                    const wg = localStorage.getItem('rp_weights'); if(wg) setWeights(JSON.parse(wg));
                    const s = localStorage.getItem('rp_shoes'); if(s) setShoes(JSON.parse(s));
                    const b = localStorage.getItem('rp_biometrics'); if(b) setBiometrics(JSON.parse(b));
                    const wt = localStorage.getItem('rp_types'); if(wt) setWorkoutTypes(JSON.parse(wt));
                } else {
                    const unsubAuth = onAuthStateChanged(auth, u => {
                        setUser(u);
                        if(u) {
                            const un1 = onSnapshot(query(collection(db, `users/${u.uid}/workouts`), orderBy('date', 'desc')), s => setWorkouts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                            const un2 = onSnapshot(query(collection(db, `users/${u.uid}/weights`), orderBy('date', 'desc')), s => setWeights(s.docs.map(d=>({id:d.id, ...d.data()}))));
                            const un3 = onSnapshot(query(collection(db, `users/${u.uid}/shoes`)), s => setShoes(s.docs.map(d=>({id:d.id, ...d.data()}))));
                            const un4 = onSnapshot(query(collection(db, `users/${u.uid}/consumption`)), s => setConsumption(s.docs.map(d=>({id:d.id, ...d.data()}))));
                            const un5 = onSnapshot(doc(db, `users/${u.uid}/settings`, 'biometrics'), s => { if(s.exists()) setBiometrics(s.data()); });
                            return () => { un1(); un2(); un3(); un4(); un5(); };
                        }
                    });
                    return () => unsubAuth();
                }
            }, [user, isDark]);

            useEffect(() => {
                if(!isFirebaseConfigured || user?.isAnonymous) {
                    localStorage.setItem('rp_workouts', JSON.stringify(workouts));
                    localStorage.setItem('rp_weights', JSON.stringify(weights));
                    localStorage.setItem('rp_shoes', JSON.stringify(shoes));
                    localStorage.setItem('rp_biometrics', JSON.stringify(biometrics));
                    localStorage.setItem('rp_types', JSON.stringify(workoutTypes));
                }
                localStorage.setItem('rp_theme', JSON.stringify(isDark));
            }, [workouts, weights, shoes, biometrics, workoutTypes, isDark, user]);

            // SAFE SAVE
            const handleSaveWorkout = async (data) => {
                let selectedType = workoutTypes.find(t => t.id === data.typeId);
                if(!selectedType) selectedType = { name: 'Outro', isDistance: false }; // Fallback
                
                const processed = {
                    ...data, 
                    duration: parseFloat(data.duration) || 0, // Force number
                    typeName: selectedType.name,
                    isDistance: selectedType.isDistance,
                    pace: (selectedType.isDistance && data.distance > 0) ? data.duration/data.distance : 0,
                    met: selectedType.isDistance ? calculateMET(data.distance, data.duration) : 0,
                    load: data.duration * (parseInt(data.rpe)||0),
                    updatedAt: new Date().toISOString()
                };

                if(isFirebaseConfigured && !user.isAnonymous) {
                    if(data.id) { const {id, ...r} = processed; await updateDoc(doc(db, `users/${user.uid}/workouts`, id), r); }
                    else { const {id, ...r} = processed; await addDoc(collection(db, `users/${user.uid}/workouts`), r); }
                } else {
                    if(data.id) setWorkouts(prev => prev.map(w => w.id === data.id ? processed : w));
                    else setWorkouts(prev => [{...processed, id: Date.now().toString()}, ...prev]);
                }
                setShowAddModal(false);
            };

            const handleDeleteWorkout = async (ids) => {
                if(!confirm("Deletar?")) return;
                if(isFirebaseConfigured && !user.isAnonymous) {
                    for(let id of ids) await deleteDoc(doc(db, `users/${user.uid}/workouts`, id));
                } else {
                    setWorkouts(prev => prev.filter(w => !ids.includes(w.id)));
                }
            };

            const handleDuplicate = async (ids) => {
                if(!confirm("Duplicar?")) return;
                const items = ids.map(id => workouts.find(w => w.id === id)).filter(Boolean).map(w => {
                    const {id, ...r} = w;
                    const d = new Date(r.date + 'T00:00:00');
                    d.setDate(d.getDate() + 7);
                    r.date = d.toISOString().substr(0,10);
                    return r;
                });
                
                if(isFirebaseConfigured && !user.isAnonymous) {
                    for(let item of items) await addDoc(collection(db, `users/${user.uid}/workouts`), item);
                } else {
                    setWorkouts(prev => [...items.map(i => ({...i, id: Math.random().toString()})), ...prev]);
                }
            };

            const saveBiometrics = async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = {
                    height: parseFloat(form.height.value),
                    dob: form.dob.value,
                    gender: form.gender.value
                };
                if(isFirebaseConfigured && !user.isAnonymous) {
                    await setDoc(doc(db, `users/${user.uid}/settings`, 'biometrics'), data);
                } else {
                    setBiometrics(data);
                }
                alert("Salvo!");
            };

            const deleteType = (id) => { if(confirm("Deletar tipo?")) setWorkoutTypes(prev => prev.filter(t => t.id !== id)); };
            const toggleTheme = () => setIsDark(!isDark);
            
            const handleLogout = () => {
                if(isFirebaseConfigured && !user.isAnonymous) signOut(auth);
                else { setUser(null); localStorage.removeItem('rp_user'); }
                setView('dashboard');
            };

            if(!user) return <LoginScreen onLogin={setUser} isDark={isDark} toggleTheme={toggleTheme} isOnline={isFirebaseConfigured}/>;

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 ${isDark ? 'bg-slate-950 text-gray-200' : 'bg-gray-50 text-gray-800'}`}>
                    <div className={`md:hidden fixed top-0 w-full z-40 p-4 flex items-center justify-between border-b transition-colors duration-300 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200 shadow-sm'}`}>
                        <div className="flex items-center gap-2">
                            <button onClick={()=>setSidebarOpen(true)} className={isDark ? 'text-white' : 'text-gray-800'}><Icon name="menu" className="w-6 h-6"/></button>
                            <span className={`font-bold text-lg ${isDark ? 'text-white' : 'text-slate-900'}`}>RunnerPro</span>
                        </div>
                        <button onClick={toggleTheme} className={isDark ? 'text-gray-400' : 'text-gray-500'}><Icon name={isDark?'sun':'moon'} className="w-5 h-5"/></button>
                    </div>

                    <Sidebar view={view} setView={setView} isDark={isDark} toggleTheme={toggleTheme} isOpen={sidebarOpen} setIsOpen={setSidebarOpen} handleLogout={handleLogout}/>

                    <main className="md:ml-64 p-4 md:p-8 pt-20 md:pt-8 max-w-7xl mx-auto">
                        {view === 'dashboard' && <Dashboard workouts={workouts} weights={weights}/>}
                        {view === 'history' && <HistoryView workouts={workouts} setWorkouts={setWorkouts} workoutTypes={workoutTypes} isDark={isDark} onEdit={(w)=>{setEditingData(w); setShowAddModal(true);}} onDuplicate={handleDuplicate} onDelete={handleDeleteWorkout}/>}
                        {view === 'weight' && <WeightView weights={weights} setWeights={setWeights} isOnline={isFirebaseConfigured} user={user}/>}
                        {view === 'metabolic' && <MetabolicView workouts={workouts} weights={weights} biometrics={biometrics} consumption={consumption} setConsumption={setConsumption} user={user} isOnline={isFirebaseConfigured}/>}
                        {view === 'equipment' && <EquipmentView shoes={shoes} setShoes={setShoes} isDark={isDark} isOnline={isFirebaseConfigured} user={user} workouts={workouts}/>}
                        {view === 'settings' && (
                            <div className="space-y-6 pb-20">
                                <h2 className="text-2xl font-bold">Configurações</h2>
                                <SettingsView user={user} workoutTypes={workoutTypes} workouts={workouts} shoes={shoes} handleLogout={()=>{}} handleAddType={()=>{}} deleteItem={deleteType} setWorkoutTypes={setWorkoutTypes} setWorkouts={setWorkouts} setShoes={setShoes} setUser={setUser} isDark={isDark} isOnline={isFirebaseConfigured}/>
                                <form onSubmit={saveBiometrics} className={`p-6 rounded-xl border ${isDark?'bg-slate-800 border-slate-700':'bg-white border-gray-200 shadow-sm'}`}>
                                    <h3 className="font-bold mb-4 flex items-center gap-2"><Icon name="user" className="w-5 h-5 text-emerald-500"/> Dados Biométricos (Para TMB)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label className="text-xs opacity-70 block mb-1">Altura (cm)</label><input name="height" type="number" defaultValue={biometrics.height} className={`w-full p-2 rounded border ${isDark?'bg-slate-900 border-slate-600':'bg-white border-gray-300 outline-none focus:border-emerald-500'}`}/></div>
                                        <div><label className="text-xs opacity-70 block mb-1">Nascimento</label><input name="dob" type="date" defaultValue={biometrics.dob} className={`w-full p-2 rounded border ${isDark?'bg-slate-900 border-slate-600':'bg-white border-gray-300 outline-none focus:border-emerald-500'}`}/></div>
                                        <div><label className="text-xs opacity-70 block mb-1">Gênero</label><select name="gender" defaultValue={biometrics.gender} className={`w-full p-2 rounded border ${isDark?'bg-slate-900 border-slate-600':'bg-white border-gray-300 outline-none focus:border-emerald-500'}`}><option value="male">Masculino</option><option value="female">Feminino</option></select></div>
                                    </div>
                                    <button className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700 transition-colors">Salvar Biometria</button>
                                </form>
                            </div>
                        )}
                    </main>

                    <button onClick={()=>{setEditingData(null); setShowAddModal(true)}} className={`md:hidden fixed bottom-6 right-6 text-white p-4 rounded-full shadow-2xl border-4 z-40 transition-transform active:scale-95 ${isDark ? 'bg-emerald-500 border-slate-900' : 'bg-emerald-600 border-white'}`}><Icon name="plus" className="w-6 h-6"/></button>
                    <AddWorkoutModal isOpen={showAddModal} onClose={()=>setShowAddModal(false)} onSave={handleSaveWorkout} initialData={editingData} workoutTypes={workoutTypes} shoes={shoes} isDark={isDark}/>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RunnerApp />);
    </script>
</body>
</html>


