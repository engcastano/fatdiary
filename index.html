
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle Calorias ‚Äî v7</title>
<style>
  :root{
    --bg:#f4f5f7; --text:#111827; --muted:#6b7280; --card:#ffffff; --primary:#111827;
    --green:#10b981; --orange:#f59e0b; --red:#ef4444; --border:#e5e7eb; --axis:#94a3b8;
    --ring:#2563eb22;
    --bluePastel: rgba(147,197,253,0.9);
    --amberPastel: rgba(252,211,77,0.9);
    --violetPastel: rgba(196,181,253,0.9);
    --greenPastel: rgba(167,243,208,0.9);
    --redPastel: rgba(254,202,202,0.9);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{
    font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1000px 500px at 100% -10%, #e2e8f0 0%, rgba(226,232,240,0) 60%),
      radial-gradient(1000px 500px at -10% 0%, #f1f5f9 0%, rgba(241,245,249,0) 60%),
      var(--bg);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index: 1000;
    background:linear-gradient(180deg, rgba(255,255,255,.97), rgba(255,255,255,.9));
    backdrop-filter: saturate(1.2) blur(6px);
    border-bottom:1px solid var(--border);
    padding:14px 18px; display:flex; align-items:center; justify-content:center;
  }
  .title{ font-weight:900;font-size:22px; letter-spacing:.2px; text-align:center; margin:0; line-height:1; }
  .gear-wrap{ position:absolute; right:12px; top:10px; }
  .gear-btn{
    width:36px;height:36px; display:flex; align-items:center; justify-content:center;
    border:1px solid var(--border); background:#fff; border-radius:10px; font-size:16px; cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.06);
  }
  .gear-btn:active{transform:translateY(1px)}

  .container{max-width:980px;margin:0 auto;padding:16px}
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; margin:16px 0;
         box-shadow:0 10px 24px rgba(17,24,39,.06); }
  .card-header{ display:flex; align-items:center; justify-content:space-between; padding:18px 18px; cursor:pointer; }
  .card-title{margin:0; font-size:17px; font-weight:800; letter-spacing:.2px}
  .chev{font-size:18px; color:var(--muted); transition:transform .2s ease}
  .card-body{padding:18px 18px; border-top:1px solid var(--border);}
  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
  .row .col{flex:1 1 200px}

  input, select, button{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
    font-size:16px; background:#fff; outline:none;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  input:focus, select:focus{ border-color:#2563eb44; box-shadow:0 0 0 6px var(--ring); }
  button.primary{background:var(--primary); color:#fff; border:none}
  button.primary:hover{filter:brightness(1.03)}
  button.ghost{background:#f8fafc}
  button:hover{box-shadow:0 4px 14px rgba(0,0,0,.08)}

  table{width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; font-size:14px; overflow:hidden; border-radius:12px; border:1px solid var(--border)}
  th, td{padding:10px 8px; text-align:center; border-bottom:1px solid var(--border); background:#fff}
  thead th{background:#f8fafc; font-weight:700}
  tbody tr:nth-child(odd) td{background:#fcfcfd}
  tbody tr:hover td{background:#f5f7fb}

  .pill{padding:6px 12px; border-radius:999px; color:#fff; font-size:13px; display:inline-block; box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .deficit{background:var(--green)}
  .neutro{background:var(--orange)}
  .superavit{background:var(--red)}
  .hidden{display:none !important}
  #configModal, #impExpModal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); padding:16px}
  #configContent, #impExpContent{background:var(--card); width:min(92vw,560px); border-radius:16px; box-shadow:0 18px 34px rgba(0,0,0,.18); padding:18px; border:1px solid var(--border)}
  canvas{width:100%; height:260px; border-radius:12px; background:#fff; border:1px solid var(--border); margin:10px 0}
  .muted{color:var(--muted);}
  .right{text-align:right}
  .toolbar{display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap}
  .subtle{font-size:12px; color:var(--muted)}

  /* Tooltip */
  #tooltip{
    position:fixed; pointer-events:none; background:#111827; color:#fff;
    padding:6px 8px; border-radius:8px; font-size:12px; line-height:1; box-shadow:0 4px 14px rgba(0,0,0,.2);
    transform:translate(-50%,-120%); white-space:nowrap; z-index: 2000; display:none;
  }
</style>
</head>
<body>
<header>
  <h1 class="title">Controle Di√°rio</h1>
  <div class="gear-wrap">
    <button class="gear-btn" onclick="openConfig()">‚öôÔ∏è</button>
  </div>
</header>

<div class="container">

  <!-- Peso -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('pesoCard', this)">
      <h3 class="card-title">Peso</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="pesoCard" class="card-body">
      <div class="row">
        <div class="col"><label class="muted">Data</label><input type="date" id="pesoData"></div>
        <div class="col"><label class="muted">Peso (kg)</label><input type="number" step="0.01" id="pesoValor" placeholder="Peso (kg)"></div>
        <div class="col"><label class="muted">&nbsp;</label><button class="primary" onclick="salvarPeso()">Salvar peso</button></div>
      </div>
      <div class="subtle">Toque no cabe√ßalho para recolher/expandir</div>
    </div>
  </div>

  <!-- TBM -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('tbmCard', this)">
      <h3 class="card-title">TBM (Mifflin‚ÄìSt Jeor)</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="tbmCard" class="card-body">
      <p id="tbmValor"><strong>TBM:</strong> 0 kcal</p>
      <p class="muted">Calculado automaticamente a partir de peso, <u>data de nascimento</u>, altura e sexo.</p>
    </div>
  </div>

  <!-- Atividade -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('atividadeCard', this)">
      <h3 class="card-title">Atividade</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="atividadeCard" class="card-body">
      <div class="row">
        <div class="col">
          <label class="muted">Tipo</label>
          <select id="atividadeTipo" onchange="setMET()">
            <option value="Corrida (Trote)" data-met="8.3">Corrida (Trote)</option>
            <option value="Corrida (10k Ritmo)" data-met="9.8">Corrida (10k Ritmo)</option>
            <option value="Muscula√ß√£o" data-met="3.5">Muscula√ß√£o</option>
            <option value="Bike Moderada" data-met="6.8">Bike Moderada</option>
            <option value="Caminhada R√°pida" data-met="3.8">Caminhada R√°pida</option>
            <option value="Escada" data-met="8.0">Escada</option>
            <option value="Remador Moderado" data-met="7.0">Remador Moderado</option>
          </select>
        </div>
        <div class="col">
          <label class="muted">Esfor√ßo</label>
          <select id="atividadeEsforco" onchange="setMET()">
            <option value="1">Muito leve</option>
            <option value="2">Leve</option>
            <option value="3" selected>M√©dio</option>
            <option value="4">Forte</option>
            <option value="5">Muito forte</option>
          </select>
        </div>
        <div class="col">
          <label class="muted">Tempo (min)</label>
          <input type="number" id="atividadeTempo" placeholder="Tempo (min)">
        </div>
        <div class="col">
          <label class="muted">MET (sugerido/edit√°vel)</label>
          <input type="number" step="0.1" id="atividadeMET" placeholder="MET">
        </div>
        <div class="col">
          <label class="muted">&nbsp;</label>
          <button class="primary" onclick="adicionarAtividade()">Adicionar</button>
        </div>
      </div>

      <table id="atividadeTabela">
        <thead><tr><th>Tipo</th><th>Tempo (min)</th><th>MET</th><th>Kcal</th><th>A√ß√£o</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Gasto Cal√≥rico -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('gastoCard', this)">
      <h3 class="card-title">Gasto Cal√≥rico</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="gastoCard" class="card-body">
      <p id="gastoValor"><strong>Gasto:</strong> 0 kcal</p>
    </div>
  </div>

  <!-- Consumo & Saldo -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('consumoCard', this)">
      <h3 class="card-title">Calorias (ingest√£o) & Saldo</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="consumoCard" class="card-body">
      <div class="row">
        <div class="col"><label class="muted">Consumo (kcal)</label><input type="number" id="consumoKcal" placeholder="Consumo (kcal)" oninput="atualizarSaldoUI()"></div>
        <div class="col right"><label class="muted">Macros</label><button class="ghost" onclick="toggleMacros()">Exibir macros</button></div>
      </div>
      <div id="macrosDiv" class="row hidden">
        <div class="col"><input type="number" id="consumoProt" placeholder="Prote√≠nas (g)"></div>
        <div class="col"><input type="number" id="consumoCarb" placeholder="Carboidratos (g)"></div>
        <div class="col"><input type="number" id="consumoGord" placeholder="Gorduras (g)"></div>
      </div>
      <p id="saldoTexto"><strong>Saldo:</strong> 0 kcal</p>
      <span id="saldoLabel" class="pill neutro">Neutro</span>
      <div class="toolbar">
        <button class="primary" onclick="salvarDia()">üíæ Salvar dia no hist√≥rico</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('dashboardCard', this)">
      <h3 class="card-title">Dashboard</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="dashboardCard" class="card-body">
      <div class="toolbar" style="position:sticky;top:0;background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px">
        <label class="muted">Janela:</label>
        <select id="janela" onchange="desenharGraficos()">
          <option value="7">7 dias</option>
          <option value="30" selected>30 dias</option>
          <option value="90">90 dias</option>
        </select>
      </div>
      <canvas id="graficoPeso"></canvas>
      <canvas id="graficoAtividade"></canvas>
      <canvas id="graficoConsumo"></canvas>
      <canvas id="graficoSaldo"></canvas>
    </div>
  </div>

  <!-- Limpar Dados -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('limparCard', this)">
      <h3 class="card-title">Limpar dados (intervalo & campos)</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="limparCard" class="card-body">
      <div class="row">
        <div class="col"><label class="muted">De</label><input type="date" id="limpaDe"></div>
        <div class="col"><label class="muted">At√©</label><input type="date" id="limpaAte"></div>
      </div>
      <div class="row">
        <div class="col"><label><input type="checkbox" id="clrPeso" checked> Peso</label></div>
        <div class="col"><label><input type="checkbox" id="clrTBM"> TBM</label></div>
        <div class="col"><label><input type="checkbox" id="clrGasto"> Gasto</label></div>
        <div class="col"><label><input type="checkbox" id="clrConsumo"> Consumo</label></div>
        <div class="col"><label><input type="checkbox" id="clrSaldo"> Saldo</label></div>
      </div>
      <div class="toolbar">
        <button class="primary" onclick="limparDados()">üßπ Limpar campos no intervalo</button>
        <button class="ghost" onclick="excluirRegistros()">üóëÔ∏è Excluir registros no intervalo</button>
      </div>
      <p class="muted">Dica: Limpar zera apenas os campos marcados. Excluir remove os registros inteiros do per√≠odo.</p>
    </div>
  </div>

  <!-- Dados (Import/Export + Tabela) -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('dadosCard', this)">
      <h3 class="card-title">Dados</h3>
      <span class="chev">‚ñº</span>
    </div>
    <div id="dadosCard" class="card-body">
      <div class="toolbar">
        <input type="file" id="csvInput" accept=".csv" />
        <button class="primary" onclick="importarCSV()">Importar CSV</button>
        <button class="ghost" onclick="exportarCSV()">Exportar CSV</button>
      </div>
      <p class="muted" style="margin-top:-2px">
        Cabe√ßalhos aceitos: <code>Data, Peso, TBM, Atividade, TBT, Consumo, D√©ficit</code> (ou <code>Deficit/Saldo</code>).
      </p>
      <h4>√öltimos 30 dias</h4>
      <table id="historicoTabela">
        <thead>
          <tr><th>Data</th><th>Peso</th><th>TBM</th><th>Gasto</th><th>Consumo</th><th>Saldo</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Tooltip element -->
<div id="tooltip"></div>

<!-- Modal Config -->
<div id="configModal">
  <div id="configContent">
    <h3 style="margin-top:0">Configura√ß√µes</h3>
    <div class="row">
      <div class="col"><input type="date" id="configDOB" placeholder="Data de nascimento"></div>
      <div class="col"><input type="number" id="configAltura" placeholder="Altura (cm)"></div>
      <div class="col">
        <select id="configSexo">
          <option value="M">Masculino</option>
          <option value="F">Feminino</option>
        </select>
      </div>
    </div>
    <h4>Metas</h4>
    <div class="row">
      <div class="col"><input type="number" step="0.1" id="metaPeso" placeholder="Meta de peso (kg)"></div>
      <div class="col"><input type="number" id="metaConsumo" placeholder="Meta de consumo (kcal/dia)"></div>
      <div class="col"><input type="number" id="metaAtividade" placeholder="Meta de atividade (kcal/dia)"></div>
    </div>
    <div class="toolbar">
      <button class="primary" onclick="salvarConfig()">Salvar</button>
      <button class="ghost" onclick="closeConfig()">‚úñ Fechar</button>
    </div>
  </div>
</div>

<script>
// ----- Seed -----
const INITIAL_HISTORICO = [{"data": "2025-02-03", "peso": 112.0, "tbm": 2142.5, "gasto": 2142.5, "consumo": 1949.0, "saldo": 193.5}, {"data": "2025-02-04", "peso": 111.9, "tbm": 2141.5, "gasto": 2142.54, "consumo": 1840.0, "saldo": 302.54}, {"data": "2025-02-05", "peso": 111.2, "tbm": 2134.5, "gasto": 2142.75, "consumo": 2750.0, "saldo": -607.25}, {"data": "2025-02-06", "peso": 111.5, "tbm": 2137.5, "gasto": 2134.51, "consumo": 2200.0, "saldo": -65.49}, {"data": "2025-02-07", "peso": 111.6, "tbm": 2138.5, "gasto": 2137.5, "consumo": 2588.0, "saldo": -450.5}, {"data": "2025-02-08", "peso": 112.6, "tbm": 2148.5, "gasto": 2137.88, "consumo": 2583.0, "saldo": -445.12}, {"data": "2025-02-09", "peso": 112.5, "tbm": 2147.5, "gasto": 2148.57, "consumo": 2400.0, "saldo": -251.43}, {"data": "2025-02-10", "peso": 111.2, "tbm": 2134.5, "gasto": 2147.45, "consumo": 2331.0, "saldo": -183.55}, {"data": "2025-02-11", "peso": 110.9, "tbm": 2131.5, "gasto": 2134.4, "consumo": 2294.0, "saldo": -159.6}, {"data": "2025-02-12", "peso": 111.7, "tbm": 2139.5, "gasto": 2129.2, "consumo": 2395.0, "saldo": -265.8}, {"data": "2025-02-13", "peso": 110.6, "tbm": 2128.5, "gasto": 2139.65, "consumo": 2227.0, "saldo": -87.35}, {"data": "2025-02-14", "peso": 111.4, "tbm": 2136.5, "gasto": 2129.42, "consumo": 2900.0, "saldo": -770.58}, {"data": "2025-02-15", "peso": 111.0, "tbm": 2132.5, "gasto": 2135.87, "consumo": 2615.0, "saldo": -479.13}, {"data": "2025-02-16", "peso": 111.0, "tbm": 2132.5, "gasto": 2132.5, "consumo": 2360.0, "saldo": -227.5}, {"data": "2025-02-17", "peso": 110.5, "tbm": 2127.5, "gasto": 2132.57, "consumo": 2448.0, "saldo": -315.43}, {"data": "2025-02-18", "peso": 111.0, "tbm": 2132.5, "gasto": 2127.78, "consumo": 3000.0, "saldo": -872.22}, {"data": "2025-02-19", "peso": 110.2, "tbm": 2124.5, "gasto": 2132.78, "consumo": 2700.0, "saldo": -567.22}, {"data": "2025-02-20", "peso": 111.2, "tbm": 2134.5, "gasto": 2125.96, "consumo": 2300.0, "saldo": -174.04}, {"data": "2025-02-21", "peso": 110.4, "tbm": 2126.5, "gasto": 2133.86, "consumo": 2400.0, "saldo": -266.14}, {"data": "2025-02-22", "peso": 109.5, "tbm": 2117.5, "gasto": 2131.7, "consumo": 3100.0, "saldo": -968.3}, {"data": "2025-02-23", "peso": 110.2, "tbm": 2124.5, "gasto": 2117.04, "consumo": 3000.0, "saldo": -882.96}, {"data": "2025-02-24", "peso": 111.6, "tbm": 2138.5, "gasto": 2124.31, "consumo": 2400.0, "saldo": -275.69}, {"data": "2025-02-25", "peso": 110.8, "tbm": 2130.5, "gasto": 2138.56, "consumo": 2100.0, "saldo": 38.56}, {"data": "2025-02-26", "peso": 110.6, "tbm": 2128.5, "gasto": 2130.59, "consumo": 2600.0, "saldo": -469.41}, {"data": "2025-02-27", "peso": 109.1, "tbm": 2113.5, "gasto": 2128.79, "consumo": 2600.0, "saldo": -471.21}, {"data": "2025-02-28", "peso": 110.1, "tbm": 2123.5, "gasto": 2114.12, "consumo": 2400.0, "saldo": -285.88}, {"data": "2025-03-01", "peso": 110.1, "tbm": 2123.5, "gasto": 2123.5, "consumo": 3000.0, "saldo": -876.5}, {"data": "2025-03-02", "peso": 110.1, "tbm": 2123.5, "gasto": 2123.5, "consumo": 3000.0, "saldo": -876.5}, {"data": "2025-03-03", "peso": 110.1, "tbm": 2123.5, "gasto": 2123.5, "consumo": 2800.0, "saldo": -676.5}, {"data": "2025-03-04", "peso": 110.7, "tbm": 2129.5, "gasto": 2123.7, "consumo": 3000.0, "saldo": -876.3}, {"data": "2025-03-05", "peso": 110.8, "tbm": 2130.5, "gasto": 2129.44, "consumo": 2400.0, "saldo": -270.56}, {"data": "2025-03-06", "peso": 111.1, "tbm": 2133.5, "gasto": 2130.76, "consumo": 2400.0, "saldo": -269.24}, {"data": "2025-03-07", "peso": 109.9, "tbm": 2121.5, "gasto": 2132.75, "consumo": 3000.0, "saldo": -867.25}, {"data": "2025-03-08", "peso": 110.4, "tbm": 2126.5, "gasto": 2120.96, "consumo": 3200.0, "saldo": -1079.04}, {"data": "2025-03-09", "peso": 110.0, "tbm": 2122.5, "gasto": 2126.93, "consumo": 2700.0, "saldo": -573.07}, {"data": "2025-03-10", "peso": 109.4, "tbm": 2116.5, "gasto": 2122.47, "consumo": 2500.0, "saldo": -377.53}, {"data": "2025-03-11", "peso": 109.7, "tbm": 2119.5, "gasto": 2116.43, "consumo": 2900.0, "saldo": -783.57}, {"data": "2025-03-12", "peso": 109.2, "tbm": 2114.5, "gasto": 2119.6, "consumo": 2600.0, "saldo": -480.4}, {"data": "2025-03-13", "peso": 109.0, "tbm": 2112.5, "gasto": 2114.6, "consumo": 2500.0, "saldo": -385.4}, {"data": "2025-03-14", "peso": 109.1, "tbm": 2113.5, "gasto": 2112.56, "consumo": 3200.0, "saldo": -1087.44}, {"data": "2025-03-15", "peso": 107.9, "tbm": 2101.5, "gasto": 2114.4, "consumo": 3500.0, "saldo": -1385.6}, {"data": "2025-03-16", "peso": 109.1, "tbm": 2113.5, "gasto": 2095.06, "consumo": 3000.0, "saldo": -904.94}, {"data": "2025-03-17", "peso": 109.0, "tbm": 2112.5, "gasto": 2113.48, "consumo": 2600.0, "saldo": -486.52}, {"data": "2025-03-18", "peso": 109.6, "tbm": 2118.5, "gasto": 2112.74, "consumo": 2700.0, "saldo": -587.26}, {"data": "2025-03-19", "peso": 109.1, "tbm": 2113.5, "gasto": 2118.7, "consumo": 2600.0, "saldo": -481.3}, {"data": "2025-03-20", "peso": 108.2, "tbm": 2104.5, "gasto": 2113.99, "consumo": 2600.0, "saldo": -486.01}, {"data": "2025-03-21", "peso": 109.0, "tbm": 2112.5, "gasto": 2104.63, "consumo": 2600.0, "saldo": -495.37}, {"data": "2025-03-22", "peso": 108.5, "tbm": 2107.5, "gasto": 2115.09, "consumo": 3700.0, "saldo": -1584.91}, {"data": "2025-03-23", "peso": 110.8, "tbm": 2130.5, "gasto": 2130.5, "consumo": 2500.0, "saldo": -369.5}, {"data": "2025-03-24", "peso": 110.8, "tbm": 2130.5, "gasto": 2130.5, "consumo": 2400.0, "saldo": -269.5}, {"data": "2025-03-25", "peso": 110.2, "tbm": 2124.5, "gasto": 2130.65, "consumo": 2500.0, "saldo": -369.35}, {"data": "2025-03-26", "peso": 108.9, "tbm": 2111.5, "gasto": 2125.09, "consumo": 2600.0, "saldo": -474.91}, {"data": "2025-03-27", "peso": 109.3, "tbm": 2115.5, "gasto": 2111.4, "consumo": 2600.0, "saldo": -488.6}, {"data": "2025-03-28", "peso": 108.2, "tbm": 2104.5, "gasto": 2115.07, "consumo": 2800.0, "saldo": -684.93}, {"data": "2025-03-29", "peso": 108.0, "tbm": 2102.5, "gasto": 2104.58, "consumo": 3200.0, "saldo": -1095.42}, {"data": "2025-03-30", "peso": 109.4, "tbm": 2116.5, "gasto": 2102.15, "consumo": 3200.0, "saldo": -1097.85}, {"data": "2025-03-31", "peso": 110.8, "tbm": 2130.5, "gasto": 2118.54, "consumo": 0.0, "saldo": 2118.54}, {"data": "2025-04-01", "peso": 106.7, "tbm": 2089.5, "gasto": 2127.7, "consumo": 1200.0, "saldo": 927.7}, {"data": "2025-04-02", "peso": 105.9, "tbm": 2081.5, "gasto": 2081.5, "consumo": 2500.0, "saldo": -418.5}, {"data": "2025-04-03", "peso": 107.8, "tbm": 2100.5, "gasto": 2100.5, "consumo": 3000.0, "saldo": -899.5}, {"data": "2025-04-04", "peso": 107.7, "tbm": 2099.5, "gasto": 2099.5, "consumo": 3000.0, "saldo": -900.5}, {"data": "2025-04-05", "peso": 109.0, "tbm": 2112.5, "gasto": 2112.5, "consumo": 3000.0, "saldo": -887.5}, {"data": "2025-04-06", "peso": 109.0, "tbm": 2112.5, "gasto": 2112.5, "consumo": 3000.0, "saldo": -887.5}, {"data": "2025-04-07", "peso": 108.6, "tbm": 2108.5, "gasto": 2112.6, "consumo": 1000.0, "saldo": 1112.6}, {"data": "2025-04-08", "peso": 108.5, "tbm": 2107.5, "gasto": 2108.53, "consumo": 1500.0, "saldo": 608.53}, {"data": "2025-04-09", "peso": 107.4, "tbm": 2096.5, "gasto": 2108.46, "consumo": 2900.0, "saldo": -791.54}, {"data": "2025-04-10", "peso": 107.3, "tbm": 2095.5, "gasto": 2096.64, "consumo": 2800.0, "saldo": -703.36}, {"data": "2025-04-11", "peso": 109.2, "tbm": 2114.5, "gasto": 2096.47, "consumo": 2800.0, "saldo": -703.53}, {"data": "2025-04-12", "peso": 108.8, "tbm": 2110.5, "gasto": 2114.7, "consumo": 3500.0, "saldo": -1385.3}, {"data": "2025-04-13", "peso": 109.0, "tbm": 2112.5, "gasto": 2112.5, "consumo": 3000.0, "saldo": -887.5}, {"data": "2025-04-14", "peso": 109.8, "tbm": 2120.5, "gasto": 2112.53, "consumo": 1500.0, "saldo": 612.53}, {"data": "2025-04-15", "peso": 109.1, "tbm": 2113.5, "gasto": 2120.27, "consumo": 1800.0, "saldo": 320.27}, {"data": "2025-04-16", "peso": 107.8, "tbm": 2100.5, "gasto": 2114.47, "consumo": 1800.0, "saldo": 314.47}, {"data": "2025-04-17", "peso": 108.0, "tbm": 2102.5, "gasto": 2100.62, "consumo": 3000.0, "saldo": -899.38}, {"data": "2025-04-18", "peso": 108.7, "tbm": 2109.5, "gasto": 5109.5, "consumo": 4000.0, "saldo": 1109.5}, {"data": "2025-04-19", "peso": 109.4, "tbm": 2116.5, "gasto": 2116.5, "consumo": 4000.0, "saldo": -1883.5}, {"data": "2025-04-20", "peso": 110.1, "tbm": 2123.5, "gasto": 2123.5, "consumo": 4000.0, "saldo": -1876.5}, {"data": "2025-04-21", "peso": 110.8, "tbm": 2130.5, "gasto": 2130.5, "consumo": 4000.0, "saldo": -1869.5}, {"data": "2025-04-22", "peso": 111.7, "tbm": 2139.5, "gasto": 2130.28, "consumo": 0.0, "saldo": 2130.28}, {"data": "2025-04-23", "peso": 108.3, "tbm": 2105.5, "gasto": 2140.35, "consumo": 2800.0, "saldo": -659.65}, {"data": "2025-04-24", "peso": 109.2, "tbm": 2114.5, "gasto": 2105.8, "consumo": 2800.0, "saldo": -694.2}, {"data": "2025-04-25", "peso": 109.6, "tbm": 2118.5, "gasto": 2114.56, "consumo": 2000.0, "saldo": 114.56}, {"data": "2025-04-26", "peso": 109.5, "tbm": 2117.5, "gasto": 2118.54, "consumo": 4000.0, "saldo": -1881.46}, {"data": "2025-04-27", "peso": 110.0, "tbm": 2122.5, "gasto": 2122.5, "consumo": 3000.0, "saldo": -877.5}, {"data": "2025-04-28", "peso": 110.4, "tbm": 2126.5, "gasto": 2122.4, "consumo": 0.0, "saldo": 2122.4}, {"data": "2025-04-29", "peso": 109.4, "tbm": 2116.5, "gasto": 2126.75, "consumo": 0.0, "saldo": 2126.75}, {"data": "2025-04-30", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-01", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-02", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-03", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-04", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-05", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-06", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-07", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-08", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-09", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-10", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-11", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-12", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-13", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-14", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-15", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-16", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-17", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-18", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 0.0, "saldo": 2149.5}, {"data": "2025-05-19", "peso": 112.7, "tbm": 2149.5, "gasto": 2149.5, "consumo": 1560.0, "saldo": 589.5}, {"data": "2025-05-20", "peso": 110.6, "tbm": 2128.5, "gasto": 2149.41, "consumo": 1450.0, "saldo": 699.41}, {"data": "2025-05-21", "peso": 108.7, "tbm": 2109.5, "gasto": 2130.16, "consumo": 1560.0, "saldo": 570.16}, {"data": "2025-05-22", "peso": 108.9, "tbm": 2111.5, "gasto": 2109.45, "consumo": 2400.0, "saldo": -290.55}, {"data": "2025-05-23", "peso": 108.3, "tbm": 2105.5, "gasto": 2111.44, "consumo": 2400.0, "saldo": -288.56}, {"data": "2025-05-24", "peso": 108.3, "tbm": 2105.5, "gasto": 2105.5, "consumo": 2400.0, "saldo": -294.5}, {"data": "2025-05-25", "peso": 108.3, "tbm": 2105.5, "gasto": 2105.5, "consumo": 2400.0, "saldo": -294.5}, {"data": "2025-05-26", "peso": 107.7, "tbm": 2099.5, "gasto": 2105.3, "consumo": 1500.0, "saldo": 605.3}, {"data": "2025-05-27", "peso": 107.4, "tbm": 2096.5, "gasto": 2099.4, "consumo": 1750.0, "saldo": 349.4}, {"data": "2025-05-28", "peso": 106.8, "tbm": 2090.5, "gasto": 2097.18, "consumo": 2000.0, "saldo": 97.18}, {"data": "2025-05-29", "peso": 106.7, "tbm": 2089.5, "gasto": 2090.55, "consumo": 1800.0, "saldo": 290.55}, {"data": "2025-05-30", "peso": 106.4, "tbm": 2086.5, "gasto": 2089.54, "consumo": 2000.0, "saldo": 89.54}, {"data": "2025-05-31", "peso": 105.8, "tbm": 2080.5, "gasto": 2086.8, "consumo": 2400.0, "saldo": -313.2}, {"data": "2025-06-01", "peso": 106.3, "tbm": 2085.5, "gasto": 2081.42, "consumo": 2600.0, "saldo": -518.58}, {"data": "2025-06-02", "peso": 106.8, "tbm": 2090.5, "gasto": 2085.67, "consumo": 1700.0, "saldo": 385.67}, {"data": "2025-06-03", "peso": 106.7, "tbm": 2089.5, "gasto": 2090.47, "consumo": 1800.0, "saldo": 290.47}, {"data": "2025-06-04", "peso": 107.3, "tbm": 2095.5, "gasto": 2089.2, "consumo": 1800.0, "saldo": 289.2}, {"data": "2025-06-05", "peso": 106.5, "tbm": 2087.5, "gasto": 2095.7, "consumo": 1700.0, "saldo": 395.7}, {"data": "2025-06-06", "peso": 105.9, "tbm": 2081.5, "gasto": 2087.65, "consumo": 2000.0, "saldo": 87.65}, {"data": "2025-06-07", "peso": 105.0, "tbm": 2072.5, "gasto": 2081.95, "consumo": 2000.0, "saldo": 81.95}, {"data": "2025-06-08", "peso": 104.9, "tbm": 2071.5, "gasto": 2072.53, "consumo": 2000.0, "saldo": 72.53}, {"data": "2025-06-09", "peso": 105.3, "tbm": 2075.5, "gasto": 2071.33, "consumo": 1750.0, "saldo": 321.33}, {"data": "2025-06-10", "peso": 105.1, "tbm": 2073.5, "gasto": 2075.49, "consumo": 2100.0, "saldo": -24.51}, {"data": "2025-06-11", "peso": 105.1, "tbm": 2073.5, "gasto": 2073.5, "consumo": 2000.0, "saldo": 73.5}, {"data": "2025-06-12", "peso": 104.9, "tbm": 2071.5, "gasto": 2073.61, "consumo": 1700.0, "saldo": 373.61}, {"data": "2025-06-13", "peso": 104.4, "tbm": 2066.5, "gasto": 2071.62, "consumo": 1900.0, "saldo": 171.62}, {"data": "2025-06-14", "peso": 103.1, "tbm": 2053.5, "gasto": 2075.35, "consumo": 3000.0, "saldo": -924.65}, {"data": "2025-06-15", "peso": 103.5, "tbm": 2057.5, "gasto": 2056.3, "consumo": 2000.0, "saldo": 56.3}, {"data": "2025-06-16", "peso": 104.3, "tbm": 2065.5, "gasto": 2057.3, "consumo": 2000.0, "saldo": 57.3}, {"data": "2025-06-17", "peso": 103.6, "tbm": 2058.5, "gasto": 2066.08, "consumo": 2100.0, "saldo": -33.92}, {"data": "2025-06-18", "peso": 103.4, "tbm": 2056.5, "gasto": 2058.7, "consumo": 2200.0, "saldo": -141.3}, {"data": "2025-06-19", "peso": 102.2, "tbm": 2044.5, "gasto": 2056.45, "consumo": 2800.0, "saldo": -743.55}, {"data": "2025-06-20", "peso": 102.8, "tbm": 2050.5, "gasto": 2043.67, "consumo": 2300.0, "saldo": -256.33}, {"data": "2025-06-21", "peso": 102.7, "tbm": 2049.5, "gasto": 2051.13, "consumo": 5000.0, "saldo": -2948.87}, {"data": "2025-06-22", "peso": 104.1, "tbm": 2063.5, "gasto": 2042.76, "consumo": 2100.0, "saldo": -57.24}, {"data": "2025-06-23", "peso": 104.1, "tbm": 2063.5, "gasto": 2063.5, "consumo": 1750.0, "saldo": 313.5}, {"data": "2025-06-24", "peso": 103.1, "tbm": 2053.5, "gasto": 2064.92, "consumo": 1900.0, "saldo": 164.92}, {"data": "2025-06-25", "peso": 103.2, "tbm": 2054.5, "gasto": 2053.45, "consumo": 2300.0, "saldo": -246.55}, {"data": "2025-06-26", "peso": 103.1, "tbm": 2053.5, "gasto": 2054.55, "consumo": 2000.0, "saldo": 54.55}, {"data": "2025-06-27", "peso": 101.8, "tbm": 2040.5, "gasto": 2053.07, "consumo": 2200.0, "saldo": -146.93}, {"data": "2025-06-28", "peso": 101.8, "tbm": 2040.5, "gasto": 2040.5, "consumo": 2850.0, "saldo": -809.5}, {"data": "2025-06-29", "peso": 101.1, "tbm": 2033.5, "gasto": 2045.46, "consumo": 3000.0, "saldo": -954.54}, {"data": "2025-06-30", "peso": 101.1, "tbm": 2033.5, "gasto": 2033.5, "consumo": 2100.0, "saldo": -66.5}, {"data": "2025-07-01", "peso": 101.8, "tbm": 2040.5, "gasto": 2032.51, "consumo": 2000.0, "saldo": 32.51}, {"data": "2025-07-02", "peso": 101.4, "tbm": 2036.5, "gasto": 2042.13, "consumo": 2000.0, "saldo": 42.13}, {"data": "2025-07-03", "peso": 101.3, "tbm": 2035.5, "gasto": 2036.69, "consumo": 2400.0, "saldo": -363.31}, {"data": "2025-07-04", "peso": 101.4, "tbm": 2036.5, "gasto": 2035.5, "consumo": 2600.0, "saldo": -564.5}, {"data": "2025-07-05", "peso": 101.1, "tbm": 2033.5, "gasto": 2039.5, "consumo": 3400.0, "saldo": -1360.5}, {"data": "2025-07-06", "peso": 101.3, "tbm": 2035.5, "gasto": 2035.5, "consumo": 3000.0, "saldo": -964.5}, {"data": "2025-07-07", "peso": 101.4, "tbm": 2036.5, "gasto": 2036.5, "consumo": 1670.0, "saldo": 366.5}, {"data": "2025-07-08", "peso": 101.1, "tbm": 2033.5, "gasto": 2037.5, "consumo": 2300.0, "saldo": -262.5}, {"data": "2025-07-09", "peso": 100.2, "tbm": 2024.5, "gasto": 2038.75, "consumo": 2600.0, "saldo": -561.25}, {"data": "2025-07-10", "peso": 102.2, "tbm": 2044.5, "gasto": 2020.17, "consumo": 2300.0, "saldo": -279.83}, {"data": "2025-07-11", "peso": 101.9, "tbm": 2041.5, "gasto": 2045.33, "consumo": 2300.0, "saldo": -254.67}, {"data": "2025-07-12", "peso": 101.9, "tbm": 2041.5, "gasto": 2041.5, "consumo": 3800.0, "saldo": -1758.5}, {"data": "2025-07-13", "peso": 101.1, "tbm": 2033.5, "gasto": 2043.03, "consumo": 2900.0, "saldo": -856.97}, {"data": "2025-07-14", "peso": 101.3, "tbm": 2035.5, "gasto": 2032.83, "consumo": 3000.0, "saldo": -967.17}, {"data": "2025-07-15", "peso": 101.1, "tbm": 2033.5, "gasto": 2036.2, "consumo": 3000.0, "saldo": -963.8}, {"data": "2025-07-16", "peso": 101.52, "tbm": 2037.75, "gasto": 2030.45, "consumo": 3800.0, "saldo": -1769.55}, {"data": "2025-07-17", "peso": 101.95, "tbm": 2042.0, "gasto": 2036.49, "consumo": 3000.0, "saldo": -963.51}, {"data": "2025-07-18", "peso": 102.37, "tbm": 2046.25, "gasto": 2046.25, "consumo": 4000.0, "saldo": -1953.75}, {"data": "2025-07-19", "peso": 102.8, "tbm": 2050.5, "gasto": 2050.5, "consumo": 4000.0, "saldo": -1949.5}, {"data": "2025-07-20", "peso": 103.22, "tbm": 2054.75, "gasto": 2045.67, "consumo": 4000.0, "saldo": -1954.33}, {"data": "2025-07-21", "peso": 103.65, "tbm": 2059.0, "gasto": 2059.0, "consumo": 4000.0, "saldo": -1941.0}, {"data": "2025-07-22", "peso": 104.07, "tbm": 2063.25, "gasto": 2063.25, "consumo": 0.0, "saldo": 2063.25}, {"data": "2025-07-23", "peso": 104.5, "tbm": 2067.5, "gasto": 2060.18, "consumo": 2300.0, "saldo": -239.82}, {"data": "2025-07-24", "peso": 103.2, "tbm": 2054.5, "gasto": 2071.67, "consumo": 2300.0, "saldo": -228.33}, {"data": "2025-07-25", "peso": 102.3, "tbm": 2045.5, "gasto": 2056.9, "consumo": 3200.0, "saldo": -1143.1}, {"data": "2025-07-26", "peso": 103.9, "tbm": 2061.5, "gasto": 2028.3, "consumo": 4000.0, "saldo": -1971.7}, {"data": "2025-07-27", "peso": 103.9, "tbm": 2061.5, "gasto": 2061.5, "consumo": 3000.0, "saldo": -938.5}, {"data": "2025-07-28", "peso": 103.9, "tbm": 2061.5, "gasto": 2061.5, "consumo": 2200.0, "saldo": -138.5}, {"data": "2025-07-29", "peso": 104.9, "tbm": 2071.5, "gasto": 2058.75, "consumo": 1800.0, "saldo": 258.75}, {"data": "2025-07-30", "peso": 103.5, "tbm": 2057.5, "gasto": 2077.68, "consumo": 2400.0, "saldo": -322.32}, {"data": "2025-07-31", "peso": 103.3, "tbm": 2055.5, "gasto": 2057.99, "consumo": 2500.0, "saldo": -442.01}, {"data": "2025-08-01", "peso": 102.2, "tbm": 2044.5, "gasto": 2057.56, "consumo": 3200.0, "saldo": -1142.44}, {"data": "2025-08-02", "peso": 100.6, "tbm": 2028.5, "gasto": 2051.03, "consumo": 3400.0, "saldo": -1348.97}, {"data": "2025-08-03", "peso": 102.5, "tbm": 2047.5, "gasto": 2002.85, "consumo": 4000.0, "saldo": -1997.15}, {"data": "2025-08-04", "peso": 103.0, "tbm": 2052.5, "gasto": 2046.27, "consumo": 2550.0, "saldo": -503.73}, {"data": "2025-08-05", "peso": 103.5, "tbm": 2057.5, "gasto": 2051.27, "consumo": 2500.0, "saldo": -448.73}, {"data": "2025-08-06", "peso": 103.2, "tbm": 2054.5, "gasto": 2058.7, "consumo": 3500.0, "saldo": -1441.3}, {"data": "2025-08-07", "peso": 103.3, "tbm": 2055.5, "gasto": 2054.25, "consumo": 6000.0, "saldo": -3945.75}, {"data": "2025-08-08", "peso": 104.9, "tbm": 2071.5, "gasto": 2055.57, "consumo": 3000.0, "saldo": -944.43}, {"data": "2025-08-09", "peso": 106.4, "tbm": 2086.5, "gasto": 2086.5, "consumo": 3000.0, "saldo": -913.5}, {"data": "2025-08-10", "peso": 105.9, "tbm": 2081.5, "gasto": 2088.58, "consumo": 3000.0, "saldo": -911.42}, {"data": "2025-08-11", "peso": 104.3, "tbm": 2065.5, "gasto": 2085.43, "consumo": 1850.0, "saldo": 235.43}, {"data": "2025-08-12", "peso": 104.3, "tbm": 2065.5, "gasto": 2065.5, "consumo": 1900.0, "saldo": 165.5}, {"data": "2025-08-13", "peso": 103.5, "tbm": 2057.5, "gasto": 2068.68, "consumo": 2600.0, "saldo": -531.32}, {"data": "2025-08-14", "peso": 102.4, "tbm": 2046.5, "gasto": 2060.53, "consumo": 2700.0, "saldo": -639.47}, {"data": "2025-08-15", "peso": 102.2, "tbm": 2044.5, "gasto": 2046.93, "consumo": 3500.0, "saldo": -1453.07}, {"data": "2025-08-16", "peso": 102.3, "tbm": 2045.5, "gasto": 2045.5, "consumo": 4000.0, "saldo": -1954.5}, {"data": "2025-08-17", "peso": 104.2, "tbm": 2064.5, "gasto": 1999.27, "consumo": 4500.0, "saldo": -2500.73}, {"data": "2025-08-18", "peso": 104.3, "tbm": 2065.5, "gasto": 2064.5, "consumo": 2400.0, "saldo": -335.5}, {"data": "2025-08-19", "peso": 102.9, "tbm": 2051.5, "gasto": 2069.35, "consumo": 2600.0, "saldo": -530.65}, {"data": "2025-08-20", "peso": 103.4, "tbm": 2056.5, "gasto": 2048.42, "consumo": 2800.0, "saldo": -751.58}, {"data": "2025-08-21", "peso": 102.8, "tbm": 2050.5, "gasto": 2058.15, "consumo": 2800.0, "saldo": -741.85}, {"data": "2025-08-22", "peso": 104.6, "tbm": 2068.5, "gasto": 2045.55, "consumo": 0.0, "saldo": 2045.55}];

// ----- Estado -----
let atividades = [];
let historico = JSON.parse(localStorage.getItem("historico")) || [];
let config = JSON.parse(localStorage.getItem("config")) || {altura:190, sexo:"M", dob:"", metaPeso:null, metaConsumo:null, metaAtividade:null};

if (historico.length === 0 && INITIAL_HISTORICO && INITIAL_HISTORICO.length) {
  historico = INITIAL_HISTORICO;
  localStorage.setItem("historico", JSON.stringify(historico));
  const last = historico[historico.length-1];
  if (last && last.peso) localStorage.setItem("ultimoPeso", last.peso);
}

// ----- Tooltip helpers -----
const chartsMeta = {};
const tt = document.getElementById('tooltip');
function showTT(text, x, y){ tt.textContent = text; tt.style.left = x+'px'; tt.style.top = y+'px'; tt.style.display='block'; }
function hideTT(){ tt.style.display='none'; }

function attachTooltip(id){
  const c = document.getElementById(id);
  if (!c || (chartsMeta[id] && chartsMeta[id].attached)) return;
  c.addEventListener('mousemove', (e)=>{
    const meta = chartsMeta[id]; if(!meta) return;
    const rect = c.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
    let found = null;
    for(const b of (meta.bars||[])){
      const y1 = b.h >= 0 ? b.y : b.y + b.h;
      const y2 = b.h >= 0 ? b.y + b.h : b.y;
      if (x>=b.x && x<=b.x+b.w && y>=y1 && y<=y2){ found = b; break; }
    }
    if(found){
      const label = (meta.labels && meta.labels[found.i]) ? meta.labels[found.i] : ('#'+(found.i+1));
      const val = meta.tooltipValues ? meta.tooltipValues[found.i] : found.value;
      showTT(label + ': ' + Math.round(val), e.clientX, e.clientY);
    } else hideTT();
  });
  c.addEventListener('mouseleave', hideTT);
  chartsMeta[id] = Object.assign(chartsMeta[id]||{}, {attached:true});
}

// ----- Util -----
function toggleCard(id, headerEl){
  const body = document.getElementById(id);
  const chev = headerEl.querySelector('.chev');
  if(body.classList.contains('hidden')){ body.classList.remove('hidden'); chev.textContent='‚ñ≤'; }
  else { body.classList.add('hidden'); chev.textContent='‚ñº'; }
}
function openConfig(){ document.getElementById('configModal').style.display='flex'; }
function closeConfig(){ document.getElementById('configModal').style.display='none'; }

function setToday(elId){
  const d = new Date(); const pad=n=>String(n).padStart(2,'0');
  const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const el = document.getElementById(elId); if (el) el.value = v;
}
function toISO(d){
  if (!d) return null;
  const t = new Date(d);
  if (isNaN(t)) return null;
  const pad=n=>String(n).padStart(2,'0');
  return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
}
function parseISO(s){
  if (!s) return null;
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
}

// Idade por data usando DOB
function idadeNaData(isoDate){
  if (!config.dob) return config.idade || 30;
  const d = parseISO(isoDate) || new Date();
  const dob = parseISO(config.dob);
  if (!dob) return config.idade || 30;
  let age = d.getFullYear() - dob.getFullYear();
  const m = d.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && d.getDate() < dob.getDate())) age--;
  return age;
}

// Mifflin‚ÄìSt Jeor com idade na data
function calcularTBMData(peso, isoDate){
  const a=config.altura||170, i=idadeNaData(isoDate), s=config.sexo||"M";
  if(s==="M") return 10*peso + 6.25*a - 5*i + 5;
  else return 10*peso + 6.25*a - 5*i - 161;
}
function atualizarTBM(){
  const pesoInput = parseFloat(document.getElementById("pesoValor").value);
  const peso = !isNaN(pesoInput) && pesoInput>0 ? pesoInput :
               (parseFloat(localStorage.getItem("ultimoPeso")) || (historico.length? historico[historico.length-1].peso:70));
  const d = document.getElementById("pesoData").value || toISO(new Date());
  const tbm = calcularTBMData(peso, d);
  document.getElementById("tbmValor").innerHTML = "<strong>TBM:</strong> " + Math.round(tbm) + " kcal";
  return tbm;
}

function kcalAtividade(met, tempoMin, pesoKg){
  return met * 3.5 * pesoKg / 200 * tempoMin;
}

function setMET(){
  const sel = document.getElementById('atividadeTipo');
  const effort = parseInt(document.getElementById('atividadeEsforco').value || '3',10);
  const base = parseFloat(sel.options[sel.selectedIndex].dataset.met);
  const factorMap = {1:0.8, 2:0.9, 3:1.0, 4:1.1, 5:1.2};
  const factor = factorMap[effort] || 1.0;
  document.getElementById('atividadeMET').value = (base*factor).toFixed(1);
}

function adicionarAtividade(){
  const tipo=document.getElementById("atividadeTipo").value;
  const tempo=parseFloat(document.getElementById("atividadeTempo").value)||0;
  const met=parseFloat(document.getElementById("atividadeMET").value)||0;
  const peso=parseFloat(localStorage.getItem("ultimoPeso")) || (historico.length? historico[historico.length-1].peso:70);
  const kcal=kcalAtividade(met, tempo, peso);
  atividades.push({tipo,tempo,met,kcal});
  renderAtividades();
}

function renderAtividades(){
  const tbody=document.querySelector("#atividadeTabela tbody");
  tbody.innerHTML="";
  atividades.forEach((a,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.tipo}</td><td>${Math.round(a.tempo)}</td><td>${a.met.toFixed(1)}</td><td>${Math.round(a.kcal)}</td>
    <td><button onclick="excluirAtividade(${idx})">Excluir</button></td>`;
    tbody.appendChild(tr);
  });
  atualizarGasto();
}

function excluirAtividade(i){ atividades.splice(i,1); renderAtividades(); }

function atualizarGasto(){
  const tbm=atualizarTBM();
  const gastoAtiv = atividades.reduce((s,a)=>s+a.kcal,0);
  const total=tbm+gastoAtiv;
  document.getElementById("gastoValor").innerHTML="<strong>Gasto:</strong> "+ Math.round(total) +" kcal";
  return total;
}

function salvarPeso(){
  const peso=parseFloat(document.getElementById("pesoValor").value);
  if(!peso) return;
  localStorage.setItem("ultimoPeso", peso);
  atualizarTBM(); atualizarGasto();
}

function toggleMacros(){ document.getElementById("macrosDiv").classList.toggle("hidden"); }

function atualizarSaldo(consumo,gasto){
  const saldo = Math.round(consumo - gasto);
  document.getElementById("saldoTexto").innerHTML = "<strong>Saldo:</strong> " + saldo + " kcal";
  const label=document.getElementById("saldoLabel");
  if(saldo<0){ label.textContent="D√©ficit"; label.className="pill deficit"; }
  else if(saldo===0){ label.textContent="Neutro"; label.className="pill neutro"; }
  else { label.textContent="Super√°vit"; label.className="pill superavit"; }
}

function atualizarSaldoUI(){
  const gasto = atualizarGasto();
  const consumo = parseFloat(document.getElementById("consumoKcal").value)||0;
  atualizarSaldo(consumo, gasto);
}

// ----- Charts with tooltips -----
function niceStep(range, targetTicks=5){
  const rough = range / targetTicks;
  const pow10 = Math.pow(10, Math.floor(Math.log10(Math.max(rough,1e-9))));
  const candidates = [1,2,2.5,5,10];
  let best = candidates[0]*pow10;
  let bestDiff = Math.abs(targetTicks - (range / best));
  for(const c of candidates){
    const step = c * pow10;
    const diff = Math.abs(targetTicks - (range / step));
    if(diff < bestDiff){ bestDiff = diff; best = step; }
  }
  return best;
}

function barChart(id, dados, titulo, opts={}){
  const c=document.getElementById(id);
  const ctx=c.getContext("2d");
  const DPR = devicePixelRatio || 1;
  const W = c.width = Math.floor(c.clientWidth * DPR);
  const H = c.height = Math.floor(260 * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,W,H);

  const padL=52, padR=12, padT=30, padB=56;
  ctx.font="600 13px -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
  ctx.fillStyle="#111827";
  ctx.fillText(titulo,12,20);

  if(!dados.length) return;

  let filtered = dados.filter(v=>v!=null);
  let minV = Math.min(...filtered);
  let maxV = Math.max(...filtered);
  if (opts.hline !== undefined){
    if (Array.isArray(opts.hline)){
      const vals = opts.hline.filter(v=>v!=null);
      if(vals.length){ minV = Math.min(minV, ...vals); maxV = Math.max(maxV, ...vals); }
    } else {
      minV = Math.min(minV, opts.hline);
      maxV = Math.max(maxV, opts.hline);
    }
  }
  if (!isFinite(minV) || !isFinite(maxV)) { minV=0; maxV=1; }
  if (minV===maxV){ minV = 0; maxV = (maxV||1)*1.2; }
  const range = maxV - minV;
  const yStep = niceStep(range, 5);
  const yMin = Math.floor(minV / yStep) * yStep;
  const yMax = Math.ceil(maxV / yStep) * yStep;

  const innerW = (W/DPR - padL - padR);
  const innerH = (H/DPR - padT - padB);

  const count = Math.max(1, dados.length);
  const gap = Math.max(2, innerW / count * 0.3);
  const barW = Math.max(3, innerW / count - gap);

  const X = (i)=> padL + i*(barW + gap);
  const Y = (v)=> (H/DPR - padB) - ((v - yMin)/(yMax - yMin)) * innerH;

  // grid & y labels
  ctx.strokeStyle="#eef2f7"; ctx.lineWidth=1;
  ctx.fillStyle="#94a3b8";
  ctx.font="12px -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
  for(let y=yMin; y<=yMax+1e-9; y+=yStep){
    const yy = Y(y);
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(W/DPR - padR, yy); ctx.stroke();
    ctx.fillText(String(Math.round(y)), 8, yy+4);
  }

  // x labels
  const ticks = Math.min(7, dados.length);
  ctx.fillStyle="#94a3b8";
  ctx.textAlign="center";
  for(let t=0;t<ticks;t++){
    const idx = Math.round(t*(dados.length-1)/(ticks-1 || 1));
    const xCenter = X(idx) + barW/2;
    const label = (opts.labels && opts.labels[idx]) ? opts.labels[idx] : String(idx+1);
    ctx.fillText(label, xCenter, H/DPR - 18);
  }
  ctx.textAlign="start";

  // zero line
  if (yMin < 0 && yMax > 0){
    ctx.strokeStyle="#94a3b8"; ctx.beginPath();
    ctx.moveTo(padL, Y(0)); ctx.lineTo(W/DPR - padR, Y(0)); ctx.stroke();
  }

  const barsMeta = [];
  // bars
  for(let i=0;i<dados.length;i++){
    const v = dados[i];
    if(v==null) continue;
    const x = X(i);
    const y = Y(Math.max(v,0));
    const y0 = Y(Math.min(v,0));
    const h = Math.abs(y0 - y);
    let fill = opts.color || "rgba(0,0,0,0.7)";
    if (typeof opts.perBarColor === "function") fill = opts.perBarColor(v,i);
    ctx.fillStyle = fill;
    ctx.fillRect(x, y, barW, Math.max(1,h));
    barsMeta.push({i, x, y, w:barW, h:(y0-y), value:v});
  }

  // dashed hline (meta)
  function drawHLine(val, label){
    if(val==null || isNaN(val)) return;
    const yy = Y(val);
    ctx.save();
    ctx.strokeStyle="#ef4444"; ctx.lineWidth=2; ctx.setLineDash([6,5]);
    ctx.beginPath(); ctx.moveTo(padL, yy); ctx.lineTo(W/DPR - padR, yy); ctx.stroke();
    if(label){
      ctx.fillStyle="#ef4444"; ctx.font="bold 12px -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
      ctx.fillText(label, W/DPR - padR - 120, yy - 6);
    }
    ctx.restore();
  }

  if (Array.isArray(opts.hline)){
    ctx.save(); ctx.strokeStyle="#ef4444"; ctx.lineWidth=2; ctx.setLineDash([6,5]);
    let started=false;
    for(let i=0;i<opts.hline.length;i++){
      const v=opts.hline[i]; if(v==null) continue;
      const x = X(i)+barW/2; const y = Y(v);
      if(!started){ ctx.beginPath(); ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
    }
    if(started) ctx.stroke();
    ctx.restore();
    if(opts.hlineLabel){ drawHLine(opts.hline[opts.hline.length-1], opts.hlineLabel); }
  } else if (opts.hline !== undefined){
    drawHLine(opts.hline, opts.hlineLabel || "");
  }

  // MM7 overlay (aligned with chart orientation)
  if (opts.mm7){
    const mm = [];
    for(let i=0;i<dados.length;i++){ mm.push(i>=6 ? dados.slice(i-6,i+1).reduce((a,b)=>a+b,0)/7 : null); }
    ctx.beginPath();
    let started=false;
    for(let i=0;i<mm.length;i++){
      if(mm[i]==null) continue;
      const x = X(i)+barW/2; const y = Y(mm[i]);
      if(!started){ ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
    }
    ctx.strokeStyle="#ef4444"; ctx.lineWidth=2; ctx.setLineDash([5,4]); ctx.stroke(); ctx.setLineDash([]);
  }

  // store meta for tooltips
  chartsMeta[id] = { bars: barsMeta, labels: (opts.labels||[]), tooltipValues: (opts.tooltipValues||null), attached: chartsMeta[id]?.attached };
  attachTooltip(id);
}

function desenharGraficos(){
  const win = parseInt(document.getElementById("janela").value||"30",10);
  const slice = (arr)=> (arr.length>win? arr.slice(-win):arr);

  const pesosAll = historico.map(h=>h.peso||0);
  const ativsAll = historico.map(h=> (h.gasto||0) - (h.tbm||0) );
  const consAll  = historico.map(h=>h.consumo||0);
  const saldAll  = historico.map(h=>h.saldo ?? ((h.consumo||0)-(h.gasto||0)));
  const labelsAll= historico.map(h=> (h.data||"").slice(5));

  const pesos = slice(pesosAll);
  const ativs = slice(ativsAll);
  const consumos = slice(consAll);
  const saldosOrig = slice(saldAll); // original: negativo = d√©ficit, positivo = super√°vit
  // Plot rule: d√©ficit (negativo) deve ir PARA CIMA; super√°vit (positivo) PARA BAIXO
  const saldosPlot = saldosOrig.map(v => (v < 0 ? absVal(v) : -absVal(v)));
  function absVal(x){ return x < 0 ? -x : x; }
  const labels = slice(labelsAll);

  // metas
  const metaPeso = (config.metaPeso && !isNaN(config.metaPeso)) ? Number(config.metaPeso) : null;
  const metaCons = (config.metaConsumo && !isNaN(config.metaConsumo)) ? Number(config.metaConsumo) : null;
  const metaAtiv = (config.metaAtividade && !isNaN(config.metaAtividade)) ? Number(config.metaAtividade) : null;

  barChart("graficoPeso",pesos,"Peso (kg)", {
    labels,
    color: getComputedStyle(document.documentElement).getPropertyValue('--bluePastel'),
    hline: metaPeso, hlineLabel: metaPeso!=null ? "meta de peso" : null,
    tooltipValues: pesos
  });
  barChart("graficoAtividade",ativs,"Atividade (kcal)", {
    labels,
    color: getComputedStyle(document.documentElement).getPropertyValue('--amberPastel'),
    hline: metaAtiv, hlineLabel: (metaAtiv!=null ? "meta de atividade" : null),
    tooltipValues: ativs
  });
  barChart("graficoConsumo",consumos,"Consumo (kcal)", {
    labels,
    color: getComputedStyle(document.documentElement).getPropertyValue('--violetPastel'),
    hline: metaCons, hlineLabel: metaCons!=null ? "meta de consumo" : null,
    tooltipValues: consumos
  });
  barChart("graficoSaldo",saldosPlot,"Saldo (kcal) ‚Äî d√©ficit ‚Üë", {
    labels, mm7:true,
    perBarColor: (v,i)=> (saldosOrig[i] < 0 ? getComputedStyle(document.documentElement).getPropertyValue('--greenPastel')
                                            : getComputedStyle(document.documentElement).getPropertyValue('--redPastel')),
    tooltipValues: saldosOrig // tooltip mostra o saldo com sinal original
  });
}

// Tabela √∫ltimos 30 dias
function renderHistoricoTabela(){
  const tbody = document.querySelector("#historicoTabela tbody");
  tbody.innerHTML = "";
  const ultimos = historico.slice(-30);
  ultimos.forEach(r=>{
    const tr = document.createElement("tr");
    const saldo = Math.round(r.saldo ?? ((r.consumo||0)-(r.gasto||0)));
    tr.innerHTML = `<td>${r.data}</td><td>${(r.peso||0).toFixed(2)}</td><td>${Math.round(r.tbm||0)}</td><td>${Math.round(r.gasto||0)}</td><td>${Math.round(r.consumo||0)}</td><td>${saldo}</td>`;
    tbody.appendChild(tr);
  });
}

// ----- Config -----
function salvarConfig(){
  config.dob = document.getElementById("configDOB").value || config.dob || "";
  config.altura = parseFloat(document.getElementById("configAltura").value)||config.altura||170;
  config.sexo = document.getElementById("configSexo").value||config.sexo||"M";
  config.metaPeso = parseFloat(document.getElementById("metaPeso").value)||null;
  config.metaConsumo = parseFloat(document.getElementById("metaConsumo").value)||null;
  config.metaAtividade = parseFloat(document.getElementById("metaAtividade").value)||null;
  localStorage.setItem("config", JSON.stringify(config));
  closeConfig(); atualizarTBM(); atualizarGasto(); desenharGraficos();
}

// ----- Salvar dia -----
function getDateInputISO(){
  const v = document.getElementById("pesoData").value;
  if (v) return v;
  const d = new Date(); const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function salvarDia(){
  const data = getDateInputISO();
  const pesoField = parseFloat(document.getElementById("pesoValor").value);
  const peso = !isNaN(pesoField) && pesoField>0 ? pesoField :
               (parseFloat(localStorage.getItem("ultimoPeso")) || (historico.length? historico[historico.length-1].peso:0));
  const tbm = calcularTBMData(peso, data);
  const gasto = atualizarGasto();
  const consumo = parseFloat(document.getElementById("consumoKcal").value)||0;
  const saldo = Math.round(consumo - gasto);

  const idx = historico.findIndex(r=>r.data===data);
  const rec = {data, peso: Number((peso||0).toFixed(2)), tbm: Math.round(tbm||0), gasto: Math.round(gasto||0), consumo: Math.round(consumo||0), saldo};
  if (idx>=0) historico[idx] = rec; else historico.push(rec);

  localStorage.setItem("historico", JSON.stringify(historico));
  desenharGraficos();
  renderHistoricoTabela();
  alert("Dia salvo!");
  atividades = []; renderAtividades();
}

// ----- Import / Export CSV -----
function normalizeKey(s){
  return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"");
}
function detectDelimiter(headerLine){
  const cands = [",",";","\t","|"];
  let best = ","; let bestCount = 0;
  for(const d of cands){
    const count = headerLine.split(d).length-1;
    if(count > bestCount){ bestCount = count; best = d; }
  }
  return best;
}

function exportarCSV(){
  const headers = ["Data","Peso","TBM","Atividade","TBT","Consumo","D√©ficit"];
  const rows = historico.map(h=>[h.data, h.peso, h.tbm, (h.gasto - h.tbm), h.gasto, h.consumo, (h.saldo ?? (h.consumo - h.gasto))]);
  let csv = headers.join(",") + "\n";
  rows.forEach(r=>{ csv += r.join(",") + "\n"; });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "historico_calorico.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importarCSV(){
  const input = document.getElementById("csvInput");
  if (!input.files || !input.files[0]) { alert("Selecione um arquivo CSV."); return; }
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
    const lines = text.split(/\n/).filter(l=>l.trim().length>0);
    if (!lines.length) { alert("CSV vazio."); return; }

    const headerRaw = lines[0];
    const delim = detectDelimiter(headerRaw);
    const headers = headerRaw.split(delim).map(h=>h.trim());
    const norm = headers.map(normalizeKey);

    function findIdx(aliases){
      const al = aliases.map(normalizeKey);
      for(let i=0;i<norm.length;i++){ if(al.includes(norm[i])) return i; }
      return -1;
    }

    const idxData = findIdx(["data"]);
    const idxPeso = findIdx(["peso"]);
    const idxTBM  = findIdx(["tbm","tmb"]);
    const idxAtiv = findIdx(["atividade","atividadekcal","metkcal"]);
    const idxTBT  = findIdx(["tbt","gasto","gastototal"]);
    const idxCons = findIdx(["consumo","kcalconsumo","kcal"]);
    const idxDef  = findIdx(["deficit","d√©ficit","saldo","dficit"]);

    const missing = [];
    if(idxData<0) missing.push("Data");
    if(idxPeso<0) missing.push("Peso");
    if(idxTBM<0) missing.push("TBM");
    if(idxAtiv<0) missing.push("Atividade");
    if(idxTBT<0) missing.push("TBT");
    if(idxCons<0) missing.push("Consumo");
    if(idxDef<0) missing.push("D√©ficit/Saldo");

    if (missing.length){
      alert("Cabe√ßalhos faltando: " + missing.join(", ") + "\nAchados: " + headers.join(", "));
      return;
    }

    function parseNumberFlexible(s){
      if (typeof s === "number") return s;
      if (!s) return 0;
      const ss = String(s).trim().replace(",", ".");
      const v = parseFloat(ss);
      return isNaN(v) ? 0 : v;
    }
    function parseDateFlexible(s){
      if (!s) return null;
      const t = String(s).trim();
      let m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m) return `${m[1]}-${m[2]}-${m[3]}`;
      m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(m) return `${m[3]}-${m[2]}-${m[1]}`;
      const d = new Date(t);
      if(!isNaN(d)) {
        const pad=n=>String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      return null;
    }

    const newHist = [];
    for (let i=1;i<lines.length;i++){
      const parts = lines[i].split(delim).map(s=>s.trim());
      if (!parts.length || parts.every(p=>p==="")) continue;
      const data = parseDateFlexible(parts[idxData]);
      if (!data) continue;
      const peso = parseNumberFlexible(parts[idxPeso]);
      const tbm = parseNumberFlexible(parts[idxTBM]);
      const atividade = parseNumberFlexible(parts[idxAtiv]);
      const gasto = parseNumberFlexible(parts[idxTBT]);
      const consumo = parseNumberFlexible(parts[idxCons]);
      const saldo = parseNumberFlexible(parts[idxDef]);
      newHist.push({data,peso,tbm,gasto,consumo,saldo});
    }

    if (!newHist.length){ alert("Nenhuma linha v√°lida encontrada."); return; }
    historico = newHist;
    localStorage.setItem("historico", JSON.stringify(historico));
    desenharGraficos();
    renderHistoricoTabela();
    alert("Importa√ß√£o conclu√≠da!");
  };
  reader.readAsText(file, "utf-8");
}

// ----- Limpar dados / Excluir registros -----
function parseISOToDate(iso){ const m=iso?.match(/^(\d{4})-(\d{2})-(\d{2})$/); return m? new Date(+m[1],+m[2]-1,+m[3]) : null; }
function inRange(dateISO, d1ISO, d2ISO){
  if (!dateISO) return false;
  const d = parseISOToDate(dateISO); if (!d) return false;
  const d1 = d1ISO ? parseISOToDate(d1ISO) : null;
  const d2 = d2ISO ? parseISOToDate(d2ISO) : null;
  if (d1 && d < d1) return false;
  if (d2 && d > d2) return false;
  return true;
}

function limparDados(){
  const de = document.getElementById("limpaDe").value || null;
  const ate = document.getElementById("limpaAte").value || null;
  const fPeso = document.getElementById("clrPeso").checked;
  const fTBM = document.getElementById("clrTBM").checked;
  const fGasto = document.getElementById("clrGasto").checked;
  const fConsumo = document.getElementById("clrConsumo").checked;
  const fSaldo = document.getElementById("clrSaldo").checked;

  if(!fPeso && !fTBM && !fGasto && !fConsumo && !fSaldo){ alert("Selecione pelo menos um campo para limpar."); return; }

  let count=0;
  historico.forEach(r=>{
    if (inRange(r.data, de, ate)){
      if (fPeso) r.peso = 0;
      if (fTBM) r.tbm = 0;
      if (fGasto) r.gasto = 0;
      if (fConsumo) r.consumo = 0;
      if (fSaldo) r.saldo = 0;
      count++;
    }
  });
  localStorage.setItem("historico", JSON.stringify(historico));
  desenharGraficos();
  renderHistoricoTabela();
  alert("Campos limpos em " + count + " registro(s).");
}

function excluirRegistros(){
  const de = document.getElementById("limpaDe").value || null;
  const ate = document.getElementById("limpaAte").value || null;
  const before = historico.length;
  historico = historico.filter(r=> !inRange(r.data, de, ate));
  const removed = before - historico.length;
  localStorage.setItem("historico", JSON.stringify(historico));
  desenharGraficos();
  renderHistoricoTabela();
  alert("Removidos " + removed + " registro(s).");
}

// ----- Init -----
(function init(){
  setToday("pesoData");
  setToday("limpaDe");
  setToday("limpaAte");
  document.getElementById("configDOB").value = config.dob || "";
  document.getElementById("configAltura").value = config.altura||170;
  document.getElementById("configSexo").value = config.sexo||"M";
  document.getElementById("metaPeso").value = (config.metaPeso!=null? config.metaPeso : "");
  document.getElementById("metaConsumo").value = (config.metaConsumo!=null? config.metaConsumo : "");
  document.getElementById("metaAtividade").value = (config.metaAtividade!=null? config.metaAtividade : "");
  setMET();
  atualizarGasto();
  desenharGraficos();
  renderHistoricoTabela();
})();
</script>
</body>
</html>
